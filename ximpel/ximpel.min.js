console||(console={log:function(){},debug:function(){},warn:function(){},error:function(){}}),Object.keys||(Object.keys=function(a){a!==Object(a)&&ximpel.error("Object.keys() called on a non-object");var c;for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&keys.push(c);return keys}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null==this)throw new TypeError(" this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(arguments.length>1&&(c=b),d=0;d<f;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}}),Array.prototype.filter||(Array.prototype.filter=function(a){"use strict";if(null==this)throw new TypeError;var b=Object(this),c=b.length>>>0;if("function"!=typeof a)throw new TypeError;for(var d=[],e=arguments[1],f=0;f<c;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d}),Date.now||(Date.now=function(){return(new Date).getTime()});var ximpel={};ximpel.mediaTypeDefinitions={},ximpel.availableMediaTypes={},ximpel.ximpelTags=["ximpel","playlist","subject","media","description","score","variable","config","leadsTo","sequence","parallel","overlay","question","questions","option","source"],ximpel.LOG_PREFIX="[XIMPEL] ",ximpel.DEFAULT_PLAYER_ELEMENT="ximpel_player",ximpel.getElement=function(a){if(!a)return!1;if("string"==typeof a||a instanceof String){var b=$("#"+a);if(1===b.length)return b}else{if(ximpel.isElement(a))return $(a);if(ximpel.isJQueryObject(a)&&1===a.length)return a}return!1},ximpel.wrapInJquery=function(a){return a instanceof jQuery?a:$(a)},ximpel.isElement=function(a){return a instanceof HTMLElement},ximpel.isJQueryObject=function(a){return a instanceof jQuery},ximpel.logFunctionFactory=function(a,b,c){return function(d){a(ximpel.isObject(d)?d:b+"-"+c+"- "+d)}},ximpel.error=ximpel.logFunctionFactory(console.error.bind(console),ximpel.LOG_PREFIX,"ERROR"),ximpel.warn=ximpel.logFunctionFactory(console.warn.bind(console),ximpel.LOG_PREFIX,"WARNING"),ximpel.debug=ximpel.logFunctionFactory(console.debug.bind(console),ximpel.LOG_PREFIX,"DEBUG"),ximpel.log=ximpel.logFunctionFactory(console.log.bind(console),ximpel.LOG_PREFIX,"INFO"),ximpel.isObject=function(a){return a===Object(a)},ximpel.filterArrayOfObjects=function(a,b,c){var d=a.filter(function(a){return a[b]===c});return d},ximpel.registerMediaType=function(a){if(!a.hasOwnProperty("mediaTypeId"))return ximpel.warn('Media type registration failed! The media type registration object has no "mediaTypeId" property!'),!1;var b=ximpel.ximpelTags;if($.inArray(a.mediaTypeId,b)>-1)return ximpel.warn("Media type registration failed! The media type uses a tag-name ("+a.mediaTypeId+") that is already in use by ximpel!"),!1;var c=Object.getOwnPropertyNames(ximpel.availableMediaTypes);$.inArray(a.mediaTypeId,c)>-1&&ximpel.warn("Media type registration failed! The media type uses a 'mediaTypeId' ('"+a.mediaTypeId+"') that is already used by another media type."),ximpel.availableMediaTypes[a.mediaTypeId]=a},ximpel.View=function(){},ximpel.View.prototype.RENDER_EVENT="view_render",ximpel.View.prototype.ATTACH_EVENT="view_attach",ximpel.View.prototype.DETACH_EVENT="view_detach",ximpel.View.prototype.DESTROY_EVENT="view_destroyed",ximpel.View.prototype.init=function(a,b){this.pubSub=new ximpel.PubSub,b=b||$(document.createElement("div")),this.$el=ximpel.wrapInJquery(b),this.model=a},ximpel.View.prototype.render=function(a){this.renderView&&this.renderView(a);var b=this.$el.parent();return a&&b[0]!==a[0]&&(this.detach(),this.attachTo(a)),this.pubSub.publish(this.RENDER_EVENT),this},ximpel.View.prototype.destroy=function(){this.destroyView&&"function"==typeof this.destroyView&&this.destroyView(),this.$el&&this.$el.remove(),this.$el=null,this.model=null,this.pubSub&&this.pubSub.publish(this.DESTROY_EVENT),this.pubSub=null},ximpel.View.prototype.attachTo=function(a){return this.$el.appendTo(a),this.pubSub.publish(this.ATTACH_EVENT),this},ximpel.View.prototype.detach=function(){return this.$el.detach(),this.pubSub.publish(this.DETACH_EVENT),this},ximpel.View.prototype.onOneClick=function(a){return this.$el.one("click",a),this},ximpel.View.prototype.onClick=function(a){return this.$el.click(a),this},ximpel.View.prototype.onRender=function(a){return this.pubSub.subscribe(this.RENDER_EVENT,a),this},ximpel.View.prototype.onUpdate=function(a){return this.pubSub.subscribe(this.UPDATE_EVENT,a),this},ximpel.View.prototype.onAttach=function(a){return this.pubSub.subscribe(this.ATTACH_EVENT,a),this},ximpel.View.prototype.onDetach=function(a){return this.pubSub.subscribe(this.DETACH_EVENT,a),this},ximpel.View.prototype.setElement=function(a){return this.$el=a instanceof Jquery?a:$(a),this},ximpel.Model=function(){},ximpel.Model.prototype.get=function(a){return this[a]},ximpel.Model.prototype.set=function(a,b){return this[a]=b,this},ximpel.PlaylistModel=function(){this.subjectModels={},this.mediaList=[],this.firstSubjectToPlay="",this.variableModifiers=[]},ximpel.PlaylistModel.prototype=new ximpel.Model,ximpel.SubjectModel=function(){this.variableModifiers=[],this.sequenceModel=null,this.leadsToList=[]},ximpel.SubjectModel.prototype=new ximpel.Model,ximpel.SubjectModel.prototype.description="",ximpel.SubjectModel.prototype.subjectId="",ximpel.SubjectModel.prototype.getId=function(){return this.subjectId},ximpel.SequenceModel=function(){this.list=[]},ximpel.SequenceModel.prototype=new ximpel.Model,ximpel.SequenceModel.prototype.ORDER_DEFAULT="default",ximpel.SequenceModel.prototype.ORDER_RANDOM="random",ximpel.SequenceModel.prototype.order=ximpel.SequenceModel.prototype.ORDER_DEFAULT,ximpel.SequenceModel.prototype.add=function(a){this.list.push(a)},ximpel.ParallelModel=function(){this.list=[]},ximpel.ParallelModel.prototype=new ximpel.Model,ximpel.ParallelModel.prototype.add=function(a){this.list.push(a)},ximpel.MediaModel=function(){this.overlays=[],this.questionLists=[],this.customAttributes={},this.customElements=[],this.leadsToList=[],this.variableModifiers=[]},ximpel.MediaModel.prototype=new ximpel.Model,ximpel.MediaModel.prototype.description="",ximpel.MediaModel.prototype.mediaType=null,ximpel.MediaModel.prototype.duration=0,ximpel.MediaModel.prototype.repeat=!1,ximpel.MediaModel.prototype.mediaId=null,ximpel.MediaModel.prototype.getId=function(){return this.mediaId},ximpel.QuestionListModel=function(){this.startTime=0,this.questionTimeLimit=0,this.questions=[]},ximpel.QuestionListModel.prototype=new ximpel.Model,ximpel.QuestionModel=function(){this.type="boolean",this.startTime=0,this.timeLimit=null,this.questionText="",this.answer=!0,this.options=[],this.variableModifiers=[]},ximpel.QuestionModel.prototype=new ximpel.Model,ximpel.QuestionOptionModel=function(){this.optionName="",this.optionText=""},ximpel.QuestionOptionModel.prototype=new ximpel.Model,ximpel.VariableModifierModel=function(){},ximpel.VariableModifierModel.prototype=new ximpel.Model,ximpel.VariableModifierModel.prototype.OPERATION_SET="set",ximpel.VariableModifierModel.prototype.OPERATION_ADD="add",ximpel.VariableModifierModel.prototype.OPERATION_SUBSTRACT="substract",ximpel.VariableModifierModel.prototype.OPERATION_MULTIPLY="multiply",ximpel.VariableModifierModel.prototype.OPERATION_DIVIDE="divide",ximpel.VariableModifierModel.prototype.OPERATION_POWER="power",ximpel.VariableModifierModel.prototype.id="",ximpel.VariableModifierModel.prototype.operation="set",ximpel.VariableModifierModel.prototype.value=0,ximpel.ConditionModel=function(){},ximpel.ConditionModel.prototype=new ximpel.Model,ximpel.ConditionModel.prototype.condition=null,ximpel.LeadsToModel=function(){},ximpel.LeadsToModel.prototype=new ximpel.Model,ximpel.LeadsToModel.prototype.subject=null,ximpel.LeadsToModel.prototype.conditionModel=null,ximpel.OverlayModel=function(){this.variableModifiers=[],this.leadsToList=[]},ximpel.OverlayModel.prototype=new ximpel.Model,ximpel.OverlayModel.prototype.SHAPE_RECTANGLE="rectangle",ximpel.OverlayModel.prototype.x=0,ximpel.OverlayModel.prototype.y=0,ximpel.OverlayModel.prototype.waitForMediaComplete=!1,ximpel.OverlayModel.prototype.leadsTo=null,ximpel.OverlayModel.prototype.startTime=0,ximpel.OverlayModel.prototype.duration=0,ximpel.OverlayModel.prototype.text="",ximpel.OverlayModel.prototype.shape="rectangle",ximpel.OverlayModel.prototype.width="200px",ximpel.OverlayModel.prototype.height="100px",ximpel.OverlayModel.prototype.side="150px",ximpel.OverlayModel.prototype.diameter="150px",ximpel.OverlayModel.prototype.textAlign="center",ximpel.OverlayModel.prototype.opacity=.4,ximpel.OverlayModel.prototype.hoverOpacity=.6,ximpel.OverlayModel.prototype.backgroundColor="white",ximpel.OverlayModel.prototype.hoverBackgroundColor=null,ximpel.OverlayModel.prototype.textColor="white",ximpel.OverlayModel.prototype.hoverTextColor=null,ximpel.OverlayModel.prototype.fontFamily="Arial",ximpel.OverlayModel.prototype.hoverFontFamily=null,ximpel.OverlayModel.prototype.fontSize="50px",ximpel.OverlayModel.prototype.hoverFontSize=null,ximpel.OverlayModel.prototype.backgroundImage=null,ximpel.OverlayModel.prototype.description=null,ximpel.ConfigModel=function(){},ximpel.ConfigModel.prototype=new ximpel.Model,ximpel.ConfigModel.prototype.mediaDirectory="",ximpel.ConfigModel.prototype.titleScreenImage="assets/ximpel_title_screen.png",ximpel.ConfigModel.prototype.enableControls=!0,ximpel.ConfigModel.prototype.controlsDisplayMethod="overlay",ximpel.ConfigModel.prototype.showScore=!1,ximpel.ConfigModel.prototype.extend=function(a){var b=Object.getOwnPropertyNames(a);b.forEach(function(b){this[b]=a[b]},this)},ximpel.CustomElementModel=function(a,b){this.elementName=a||"",this.elementAttributes=b||{}},ximpel.XimpelAppModel=function(){this.initialAppWidth="1080px",this.initialAppHeight="720px",this.$appElement=null,this.$parentElement=null,this.playlistFile=null,this.configFile=null,this.ximpelPlayer=null,this.parser=null,this.configModel=new ximpel.ConfigModel,this.playlistModel=null,this.playlistXmlDocument=null,this.configXmlDocument=null,this.filesRequestPromise=null,this.playlistRequestPromise=null,this.configRequestPromise=0,this.appReadyState=null,this.playerState=null},ximpel.XimpelAppModel.prototype=new ximpel.Model,ximpel.XimpelAppModel.prototype.PLAYER_STATE_PLAYING="player_state_playing",ximpel.XimpelAppModel.prototype.PLAYER_STATE_PAUSED="player_state_paused",ximpel.XimpelAppModel.prototype.PLAYER_STATE_STOPPED="player_state_stopped",ximpel.XimpelApp=function(a,b,c,d){var d=d||{},e=this.ximpelAppModel=new ximpel.XimpelAppModel;e.$parentElement=ximpel.getElement(d.parentElement)||e.$parentElement,e.appId=a,this.ximpelAppView=new ximpel.XimpelAppView(e,d.appElement,d.appWidth,d.appHeight),this.ximpelPlayer=null,this.parser=new ximpel.Parser,e.playlistFile=b,e.configFile=c,e.playlistXmlDocument=null,e.configXmlDocument=null,e.configModel=null,e.playlistModel=null,e.filesRequestPromise=null,e.playlistRequestPromise=null,e.configRequestPromise=null,e.hideControlsTimeoutHandler=null,e.hideCursorTimeoutHandler=null,e.appReadyState=this.APP_STATE_LOADING,e.playerState=this.ximpelAppModel.PLAYER_STATE_STOPPED},ximpel.XimpelApp.prototype.load=function(a){var b=this.ximpelAppModel,a=a||{},c=a.autoPlay!==!1;return b.filesRequestPromise=this.loadFiles(b.playlistFile,b.configFile),b.filesRequestPromise.done(function(a,d){b.playlistXmlDocument=a[0],b.configXmlDocument=d?d[0]:null;var e=this.parse(b.playlistXmlDocument,b.configXmlDocument);return e?(b.playlistModel=e.playlist,b.configModel=e.config,this.ximpelPlayer=new ximpel.Player(this.getPlayerElement(),e.playlist,e.config),this.ximpelAppModel.appReadyState=this.ximpelAppModel.APP_READY_STATE_READY,this.ximpelAppView.registerPlayHandler(this.startPlayer.bind(this)),this.ximpelAppView.registerPauseHandler(this.pausePlayer.bind(this)),this.ximpelAppView.registerStopHandler(this.stopPlayer.bind(this)),this.ximpelAppView.render(b.$parentElement),void(c===!0&&this.startPlayer())):(ximpel.error("XimelApp.load(): No XIMPEL player was created because the playlist or config file was invalid."),!1)}.bind(this)),b.filesRequestPromise},ximpel.XimpelApp.prototype.loadFiles=function(a,b,c){var d=this.ximpelAppModel;return d.playlistRequestPromise=this.requestXmlFile(a).fail(function(b,c,d){ximpel.error("XimpelApp.loadFiles(): Failed to load the playlist file ("+a+") from the server or the XML syntax is invalid (HTTP status='"+b.status+" "+b.statusText+"', message='"+c+"')")}.bind(this)),b&&(d.configRequestPromise=this.requestXmlFile(b).fail(function(a,c,d){ximpel.error("XimpelApp.loadFiles(): Failed to load the config file ("+b+") from the server or the XML syntax is invalid! (HTTP status='"+a.status+" "+a.statusText+"', message='"+c+"')")}.bind(this))),$.when(d.playlistRequestPromise,d.configRequestPromise)},ximpel.XimpelApp.prototype.requestXmlFile=function(a,b){var c=$.ajax({type:"GET",url:a,dataType:"xml",cache:!1});return c},ximpel.XimpelApp.prototype.parse=function(a,b){var d=(this.ximpelAppModel,this.parser.parse(a,b)),e=d.playlist||null,f=d.config||null;return e&&f?d:(ximpel.error("XimpelApp.parse(): Failed to parse playlist or config document."),!1)},ximpel.XimpelApp.prototype.getPlayerElement=function(){return this.ximpelAppView.getPlayerElement()},ximpel.XimpelApp.prototype.startPlayer=function(){return this.ximpelAppModel.appReadyState!==this.ximpelAppModel.APP_READY_STATE_READY?void ximpel.warn("XimpelApp.startPlayer(): XimpelApp.startPlayer(): cannot start player when app is not ready yet."):this.ximpelAppModel.playerState!==this.ximpelAppModel.PLAYER_STATE_PAUSED&&this.ximpelAppModel.playerState!==this.ximpelAppModel.PLAYER_STATE_STOPPED?void ximpel.warn("XimpelApp.startPlayer(): cannot start player when the player is not paused or stopped."):(this.ximpelAppModel.playerState=this.ximpelAppModel.PLAYER_STATE_PLAYING,this.ximpelPlayer.play(),void this.ximpelAppView.renderControls())},ximpel.XimpelApp.prototype.pausePlayer=function(){if(this.ximpelAppModel.appReadyState!==this.ximpelAppModel.APP_READY_STATE_READY)return void ximpel.warn("XimpelApp.pausePlayer(): cannot pause player when app is not ready yet.");if(this.ximpelAppModel.playerState===this.ximpelAppModel.PLAYER_STATE_PLAYING)this.ximpelAppModel.playerState=this.ximpelAppModel.PLAYER_STATE_PAUSED,this.ximpelPlayer.pause();else{if(this.ximpelAppModel.playerState!==this.ximpelAppModel.PLAYER_STATE_PAUSED)return void ximpel.warn("XimpelApp.pausePlayer(): cannot pause player when the player is stopped.");ximpel.warn("XimpelApp.pausePlayer(): cannot pause player when the player is already paused.")}this.ximpelAppView.renderControls()},ximpel.XimpelApp.prototype.stopPlayer=function(){return this.ximpelAppModel.appReadyState!==this.ximpelAppModel.APP_READY_STATE_READY?void ximpel.warn("XimpelApp.stopPlayer(): cannot stop player when app is not ready yet."):this.ximpelAppModel.playerState!==this.ximpelAppModel.PLAYER_STATE_PLAYING&&this.ximpelAppModel.playerState!==this.ximpelAppModel.PLAYER_STATE_PAUSED?void ximpel.warn("XimpelApp.stopPlayer(): cannot stop player when the player is already stopped."):(this.ximpelAppModel.playerState=this.ximpelAppModel.PLAYER_STATE_STOPPED,this.ximpelPlayer.stop(),void this.ximpelAppView.renderControls())},ximpel.XimpelApp.prototype.getAppElementWidth=function(){this.ximpelAppModel.$appElement.width()},ximpel.XimpelApp.prototype.getAppElementHeight=function(){this.ximpelAppModel.$appElement.height()},ximpel.Player=function(a,b,c){this.$playerElement=ximpel.wrapInJquery(a),this.playlistModel=b,this.configModel=c,this.subjectModels=b.subjectModels,this.firstSubjectModel=this.getFirstSubjectModel(),this.availableMediaTypes=ximpel.availableMediaTypes,this.mediaItems={},this.currentSubjectModel=null,this.pubSub=new ximpel.PubSub,this.variables=[],this.state=this.STATE_STOPPED,this.sequencePlayer=new ximpel.SequencePlayer(this),this.sequencePlayer.addEventHandler(this.sequencePlayer.EVENT_SEQUENCE_END,this.handleSequencePlayerEnd.bind(this)),this.init()},ximpel.Player.prototype.STATE_PLAYING="state_player_playing",ximpel.Player.prototype.STATE_PAUSED="state_player_paused",ximpel.Player.prototype.STATE_STOPPED="state_player_stopped",ximpel.Player.prototype.EVENT_PLAYER_END="ended",ximpel.Player.prototype.EVENT_VARIABLE_UPDATED="variable_updated",ximpel.Player.prototype.EVENT_SUBJECT_PLAYING="subject_playing",ximpel.Player.prototype.init=function(){return this.constructMediaItems(),this.applyVariableModifiers(this.playlistModel.variableModifiers),this},ximpel.Player.prototype.reset=function(a){this.state=this.STATE_STOPPED,this.currentSubjectModel=null,this.sequencePlayer.stop(),this.variables=[],this.applyVariableModifiers(this.playlistModel.variableModifiers),a&&this.clearEventHandlers()},ximpel.Player.prototype.play=function(){return this.isPlaying()?(ximpel.warn("Player.play(): play() called while already playing."),this):this.isPaused()?(this.resume(),this):(this.state=this.STATE_PLAYING,this.playSubject(this.firstSubjectModel),this)},ximpel.Player.prototype.playSubject=function(a){this.currentSubjectModel=a;var b=a.sequenceModel;this.applyVariableModifiers(a.variableModifiers),this.sequencePlayer.play(b),this.pubSub.publish(this.EVENT_SUBJECT_PLAYING,a)},ximpel.Player.prototype.resume=function(){return this.isPaused()?(this.state=this.STATE_PLAYING,this.sequencePlayer.resume(),this):(ximpel.warn("Player.resume(): resume() called while not in a paused state."),this)},ximpel.Player.prototype.pause=function(){return this.isPlaying()?(this.state=this.STATE_PAUSED,this.sequencePlayer.pause(),this):(ximpel.warn("Player.pause(): pause() called while not in a playing state."),this)},ximpel.Player.prototype.stop=function(){return this.isStopped()?(ximpel.warn("Player.stop(): stop() called while already in a stopped state."),this):(this.state=this.STATE_STOPPED,this.reset(),this)},ximpel.Player.prototype.goTo=function(a){var b=this.subjectModels[a];return b?(this.playSubject(b),this):void ximpel.warn("Player.goTo(): Cannot play a subject with subjectId '"+a+"'. There is no subject with that id.")},ximpel.Player.prototype.getVariable=function(a){return this.variables[a]},ximpel.Player.prototype.applyVariableModifiers=function(a){$.each(a,function(b,c){var d=a[b];this.applyVariableModifier(d)}.bind(this))},ximpel.Player.prototype.applyVariableModifier=function(a){var b=this.variables[a.id];switch(void 0===b&&(this.variables[a.id]=0,b=0),a.operation){case a.OPERATION_SET:var c=a.value;break;case a.OPERATION_ADD:var c=NaN===Number(b)?0:Number(b);c+=Number(a.value);break;case a.OPERATION_SUBSTRACT:var c=NaN===Number(b)?0:Number(b);c-=Number(a.value);break;case a.OPERATION_MULTIPLY:var c=NaN===Number(b)?0:Number(b);c*=Number(a.value);break;case a.OPERATION_DIVIDE:var c=NaN===Number(b)?0:Number(b);c/=Number(a.value);break;case a.OPERATION_POWER:var c=NaN===Number(b)?0:Number(b);c=Number(Math.pow(c,a.value));break;default:var c=b}this.variables[a.id]=c,this.pubSub.publish(this.EVENT_VARIABLE_UPDATED,a.id)},ximpel.Player.prototype.isPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.Player.prototype.isPaused=function(){return this.state===this.STATE_PAUSED},ximpel.Player.prototype.isStopped=function(){return this.state===this.STATE_STOPPED},ximpel.Player.prototype.determineLeadsTo=function(a){for(var b=null,c=0;c<a.length;c++){var d=a[c];if(d.conditionModel){var e=this.evaluateCondition(d.conditionModel);if(e)return d.subject}else b=d.subject}return b},ximpel.Player.prototype.evaluateCondition=function(conditionModel){for(var condition=conditionModel.condition,parsedCondition=condition,regex=/\{\{(\w+)\}\}/g,variableNames=[],variableNamesTemplated=[];match=regex.exec(condition);)variableNames.push(match[1]),variableNamesTemplated.push("{{"+match[1]+"}}");for(var variableValues=[],i=0;i<variableNames.length;i++){var variableName=variableNames[i];variableValues[i]=this.variables[variableName]}var failedToTemplateCondition=!1;if($.each(variableNamesTemplated,function(a,b){void 0!==variableValues[a]&&null!==variableValues[a]?parsedCondition=parsedCondition.replace(b,variableValues[a]):failedToTemplateCondition=!0}),failedToTemplateCondition===!0)return!1;var result=eval(parsedCondition);return(result===!0||result===!1)&&result},ximpel.Player.prototype.determineNextSubjectToPlay=function(){var a=this.determineLeadsTo(this.currentSubjectModel.leadsToList);return a},ximpel.Player.prototype.handleSequencePlayerEnd=function(){var a=this.determineNextSubjectToPlay();a&&this.goTo(a),this.pubSub.publish(this.EVENT_PLAYER_END)},ximpel.Player.prototype.getFirstSubjectModel=function(){return this.playlistModel.subjectModels[this.playlistModel.firstSubjectToPlay]},ximpel.Player.prototype.addEventHandler=function(a,b){switch(a){case this.EVENT_PLAYER_END:return this.pubSub.subscribe(this.EVENT_PLAYER_END,b);case this.EVENT_VARIABLE_UPDATED:return this.pubSub.subscribe(this.EVENT_VARIABLE_UPDATED,b);case this.EVENT_SUBJECT_PLAYING:return this.pubSub.subscribe(this.EVENT_SUBJECT_PLAYING,b);default:ximpel.warn("Player.addEventHandler(): cannot add an event handler for event '"+a+"'. This event is not used by the player.")}},ximpel.Player.prototype.clearEventHandlers=function(a){return this.pubSub.reset(),this},ximpel.Player.prototype.clearEventHandler=function(a,b){this.pubSub.unsubscribe(a,b)},ximpel.Player.prototype.constructMediaItems=function(){var a=this.getMediaModels();return a.forEach(function(a){var b=this.availableMediaTypes[a.mediaType],c=new b.mediaTypeConstructor(a.customElements,a.customAttributes,this.$playerElement,this);this.mediaItems[a.mediaId]=c}.bind(this)),this},ximpel.Player.prototype.getPlayerElement=function(){return this.$playerElement},ximpel.Player.prototype.getMediaModels=function(){return this.playlistModel.mediaList},ximpel.Player.prototype.getConfigProperty=function(a){var b=this.configModel[a];return void 0!==b?b:null},ximpel.Parser=function(){this.mediaTypeRegistrations=ximpel.availableMediaTypes,this.registeredMediaTags=Object.getOwnPropertyNames(this.mediaTypeRegistrations),this.validChildren={ximpel:["playlist","config"],playlist:["subject","score"],subject:["description","media","score","sequence","parallel"],media:["parallel","sequence"].concat(this.registeredMediaTags),parallel:["sequence"].concat(this.registeredMediaTags),sequence:["parallel"].concat(this.registeredMediaTags),overlay:["score"],score:[""],question:[""],description:[""],config:[""],__MEDIA_TYPE__:["overlay","score","question"]},this.mediaIdCounter=1},ximpel.Parser.prototype.parse=function(a,b){var c=this.parseXml(a),d=c.playlist||null,e=c.config;if(!d)return ximpel.error("Parser.parser(): Failed to parse the playlist file. The playlist file is invalid."),!1;if(b){var f=this.parseXml(b),g=f.config||null;if(!g)return ximpel.error("Parser.parse(): Failed to parse the config file. The config file is invalid."),!1}else var g=new ximpel.ConfigModel;return e&&g.extend(e),{playlist:d,config:g}},ximpel.Parser.prototype.parseXml=function(a){var b=a.childNodes[0];if(!b)return ximpel.error("Parser.parseXml(): Cannot parse the XML contents, the given XML document is empty"),null;if("ximpel"!==b.nodeName)return ximpel.error("Parser.parseXML(): Invalid document specified. The Root element must be the <ximpel> element."),null;var c=this.processXimpelNode(b);return c},ximpel.Parser.prototype.processXimpelNode=function(a){for(var b=this.getDomElementInfo(a),c={},d=0;d<b.nrOfChildElements;d++){var e=b.childElements[d];"playlist"===e.nodeName?c.playlist=this.processPlaylistNode(e):"config"===e.nodeName?c.config=this.processConfigNode(e):ximpel.warn("Parser.processXimpelNode(): Invalid child ignored! Element <"+b.tagName+"> has child <"+e.nodeName+">. Allowed children: "+this.validChildren[b.tagName].toString()+".")}return c},ximpel.Parser.prototype.processPlaylistNode=function(a){for(var b=this.getDomElementInfo(a),c=null,d=new ximpel.PlaylistModel,e=0;e<b.nrOfChildElements;e++){var f=b.childElements[e];if("subject"===f.nodeName){var g=this.processSubjectNode(d,f);d.subjectModels[g.subjectId]=g,null===c&&(c=g.subjectId)}else if("score"===f.nodeName||"variable"===f.nodeName){var h=this.processVariableNode(d,f);d.variableModifiers.push(h)}else ximpel.warn("Parser.processPlaylistNode(): Invalid child ignored! Element <"+b.tagName+"> has child <"+f.nodeName+">. Allowed children: "+this.validChildren[b.tagName].toString()+".")}return d.firstSubjectToPlay=c,d},ximpel.Parser.prototype.processSubjectNode=function(a,b){for(var c=this.getDomElementInfo(b),d=new ximpel.SubjectModel,e=0;e<c.nrOfAttributes;e++){var f=c.attributes[e].name,g=c.attributes[e].value;if("id"===f)d.subjectId=g;else if("leadsTo"===f){var h=new ximpel.LeadsToModel;h.subject=g,d.leadsToList.push(h)}else ximpel.warn("Parser.processSubjectNode(): Invalid attribute ignored! Attribute '"+f+"' on element <"+c.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var e=0;e<c.nrOfChildElements;e++){var i=c.childElements[e],j=i.nodeName;if("description"===j)d.description=this.processDescriptionNode(a,i);else if("media"===j)d.sequenceModel=this.processMediaNode(a,i);else if("score"===j||"variable"===j){var k=this.processVariableNode(a,i);d.variableModifiers.push(k)}else if("leadsTo"===j){var h=this.processLeadsToNode(a,i);d.leadsToList.push(h)}else ximpel.warn("Parser.processSubjectNode(): Invalid child ignored! Element <"+c.tagName+"> has child <"+j+">. Allowed children: "+this.validChildren[c.tagName].toString()+".")}return d},ximpel.Parser.prototype.processMediaNode=function(a,b){return this.processSequenceNode(a,b)},ximpel.Parser.prototype.processSequenceNode=function(a,b){for(var c=this.getDomElementInfo(b),d=new ximpel.SequenceModel,e=0;e<c.nrOfAttributes;e++){var f=c.attributes[e].name,g=c.attributes[e].value;"order"===f?d.order=g:ximpel.warn("Parser.processSequenceNode(): Invalid attribute ignored! Attribute '"+f+"' on element <"+c.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var e=0;e<c.nrOfChildElements;e++){var h=c.childElements[e],i=h.nodeName;$.inArray(i,this.registeredMediaTags)>-1?d.add(this.processMediaTypeNode(a,h)):"parallel"===i?d.add(this.processParallelNode(a,h)):"sequence"===i?d.add(this.processSequenceNode(a,h)):ximpel.warn("Parser.processSequenceNode(): Invalid child ignored! Element <"+c.tagName+"> has child <"+i+">. Allowed children: "+this.validChildren[c.tagName].toString()+".")}return d},ximpel.Parser.prototype.processParallelNode=function(a,b){for(var c=this.getDomElementInfo(b),d=new ximpel.ParallelModel,e=0;e<c.childElements;e++){var f=c.childElements[e],g=f.nodeName;$.inArray(g,this.registeredMediaTags)>-1?d.add(this.processMediaTypeNode(a,f)):"sequence"===g?d.add(this.processSequenceNode(a,f)):ximpel.warn("Parser.processParallelNode(): Invalid child ignored! Element <"+c.tagName+"> has child <"+g+">. Allowed children: "+this.validChildren[c.tagName].toString()+".")}return d},ximpel.Parser.prototype.processMediaTypeNode=function(a,b){var c=this.getDomElementInfo(b),d=new ximpel.MediaModel;d.mediaType=c.tagName;for(var e=0;e<c.nrOfAttributes;e++){var f=c.attributes[e].name,g=c.attributes[e].value;if("leadsTo"===f){var h=new ximpel.LeadsToModel;h.subject=g,d.leadsToList.push(h)}else"duration"===f?d.duration=1e3*parseFloat(g):"repeat"===f?d.repeat="true"===g:d.customAttributes[f]=g}for(var e=0;e<c.nrOfChildElements;e++){var i=c.childElements[e],j=i.nodeName;if("overlay"===j)d.overlays.push(this.processOverlayNode(a,i,e));else if("score"===j||"variable"===j){var k=this.processVariableNode(a,i);d.variableModifiers.push(k)}else if("question"===j)d.questionLists.push(this.processQuestionNode(a,i));else if("questions"===j)d.questionLists.push(this.processQuestionsNode(a,i));else if("leadsTo"===j){var h=this.processLeadsToNode(a,i);d.leadsToList.push(h)}else{for(var l={},m=0;m<i.attributes.length;m++)l[i.attributes[m].name]=i.attributes[m].value;var n=new ximpel.CustomElementModel(j,l);d.customElements.push(n)}}return d.mediaId=this.mediaIdCounter++,a.mediaList.push(d),d},ximpel.Parser.prototype.processQuestionsNode=function(a,b){for(var c=this.getDomElementInfo(b),d=new ximpel.QuestionListModel,e=0;e<c.nrOfAttributes;e++){var f=c.attributes[e].name,g=c.attributes[e].value;"startTime"===f?d.startTime=1e3*parseFloat(g):"questionTimeLimit"===f?d.questionTimeLimit=1e3*parseFloat(g):"nrOfQuestionsToAsk"===f?d.nrOfQuestionsToAsk=parseInt(g):"questionOrder"===f?d.questionOrder=g:ximpel.warn("Parser.processQuestionsNode(): Invalid attribute ignored! Attribute '"+f+"' on element <"+c.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var e=0;e<c.nrOfChildElements;e++){var h=c.childElements[e],i=h.nodeName;"question"===i?d.questions.push(this.processQuestionNode(a,h)):ximpel.warn("Parser.processQuestionsNode(): Invalid child ignored! Element <"+c.tagName+"> has child <"+i+">. Allowed children: "+this.validChildren[c.tagName].toString()+".")}return d},ximpel.Parser.prototype.processQuestionNode=function(a,b){for(var c=this.getDomElementInfo(b),d=new ximpel.QuestionModel,e="questions"===b.parentNode.nodeName,f=0;f<c.nrOfAttributes;f++){var g=c.attributes[f].name,h=c.attributes[f].value;"startTime"===g&&e===!1?d.startTime=1e3*parseFloat(h):"questionTimeLimit"===g?d.questionTimeLimit=1e3*parseFloat(h):"answer"===g?d.answer=h:ximpel.warn("Parser.processQuestionNode(): Invalid attribute ignored! Attribute '"+g+"' on element <"+c.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var i="",f=0;f<b.childNodes.length;f++){var j=b.childNodes[f];3===j.nodeType&&(i+=b.childNodes[f].nodeValue)}d.questionText=$.trim(i);for(var k=0,f=0;f<c.nrOfChildElements;f++){var l=c.childElements[f],m=l.nodeName;if("option"===m){k+=1;var n=this.processOptionNode(a,l);n.optionName=""===n.optionName?""+k:n.optionName,d.options.push(n)}else if("score"===m||"variable"===m){var o=this.processVariableNode(a,l);d.variableModifiers.push(o)}else ximpel.warn("Parser.processQuestionNode(): Invalid child ignored! Element <"+c.tagName+"> has child <"+m+">. Allowed children: "+this.validChildren[c.tagName].toString()+".")}if(d.options.length<=0){var p=new ximpel.QuestionOptionModel;p.optionName="true",p.optionText="True";var q=new ximpel.QuestionOptionModel;q.optionName="false",q.optionText="False",d.options.push(p),d.options.push(q)}if(!e){var r=new ximpel.QuestionListModel;return r.startTime=d.startTime||0,r.questions.push(d),r}return d},ximpel.Parser.prototype.processOptionNode=function(a,b){for(var c=this.getDomElementInfo(b),d=new ximpel.QuestionOptionModel,e=0;e<c.nrOfAttributes;e++){var f=c.attributes[e].name,g=c.attributes[e].value;"name"===f&&(d.optionName=g),ximpel.warn("Parser.processOptionNode(): Invalid attribute ignored! Attribute '"+f+"' on element <"+c.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var h="",e=0;e<b.childNodes.length;e++)3===b.childNodes[e].nodeType&&(h+=b.childNodes[e].nodeValue);return d.optionText=$.trim(h),d},ximpel.Parser.prototype.processVariableNode=function(a,b){for(var c=this.getDomElementInfo(b),d=new ximpel.VariableModifierModel,e=0;e<c.nrOfAttributes;e++){var f=c.attributes[e].name,g=c.attributes[e].value;"id"===f?d.id=g:"operation"===f?d.operation=g:"value"===f?d.value=g:ximpel.warn("Parser.processVariableNode(): Invalid attribute ignored! Attribute '"+f+"' on element <"+c.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var e=0;e<c.nrOfChildElements;e++){var h=c.childElements[e],i=h.nodeName;ximpel.warn("Parser.processVariableNode(): Invalid child ignored! Element <"+c.tagName+"> has child <"+i+">. No children allowed on <"+c.tagName+">.")}return d},ximpel.Parser.prototype.processLeadsToNode=function(a,b){for(var c=this.getDomElementInfo(b),d=new ximpel.LeadsToModel,e=0;e<c.nrOfAttributes;e++){var f=c.attributes[e].name,g=c.attributes[e].value;if("condition"===f)var h=g;else"subject"===f?d.subject=g:ximpel.warn("Parser.processLeadsToNode(): Invalid attribute ignored! Attribute '"+f+"' on element <"+c.tagName+"> is not supported. Make sure you spelled the attribute name correctly.");
}if(h){var i=new ximpel.ConditionModel;i.condition=h?h:null,d.conditionModel=i}else d.conditionModel=null;return d},ximpel.Parser.prototype.processDescriptionNode=function(a,b){var c=this.getDomElementInfo(b),d=b.childNodes[0],e="";return d?3===d.nodeType?e=$.trim(d.nodeValue):ximpel.warn("Parser.processDescriptionNode(): Invalid description! Element <"+c.tagName+"> has an invalid child node. Only text is allowed inside the <description> element."):e="",e},ximpel.Parser.prototype.processOverlayNode=function(a,b,c){var d=this.getDomElementInfo(b),e=new ximpel.OverlayModel;e.index=c;for(var f=0;f<d.nrOfAttributes;f++){var g=d.attributes[f].name,h=d.attributes[f].value;if("x"===g)e.x=parseInt(h);else if("y"===g)e.y=parseInt(h);else if("shape"===g)e.shape=h;else if("width"===g)e.width=parseInt(h);else if("height"===g)e.height=parseInt(h);else if("side"===g)e.side=parseInt(h);else if("diameter"===g)e.diameter=parseInt(h);else if("leadsTo"===g){var i=new ximpel.LeadsToModel;i.subject=h,e.leadsToList.push(i)}else"startTime"===g?e.startTime=1e3*parseFloat(h):"duration"===g?e.duration=1e3*parseFloat(h):"text"===g?e.text=h:"alpha"===g?e.opacity=h:"hoverAlpha"===g?e.hoverOpacity=h:"backgroundColor"===g?e.backgroundColor=h:"hoverBackgroundColor"===g?e.hoverBackgroundColor=h:"textColor"===g?e.textColor=h:"hoverTextColor"===g?e.hoverTextColor=h:"fontFamily"===g?e.fontFamily=h:"hoverFontFamily"===g?e.hoverFontFamily=h:"fontSize"===g?e.fontSize=h:"hoverFontSize"===g?e.hoverFontSize=h:"image"===g?e.backgroundImage=h:"hoverImage"===g?e.hoverBackgroundImage=h:"waitForMediaComplete"===g?e.waitForMediaComplete=h:"description"===g?e.description=h:ximpel.warn("Parser.processOverlayNode(): Invalid attribute ignored! Attribute '"+g+"' on element <"+d.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var f=0;f<d.nrOfChildElements;f++){var j=d.childElements[f],k=j.nodeName;if("score"===k||"variable"===k){var l=this.processVariableNode(a,j);e.variableModifiers.push(l)}else if("leadsTo"===k){var i=this.processLeadsToNode(a,j);e.leadsToList.push(i)}else ximpel.warn("Parser.processOverlayNode(): Invalid child ignored! Element <"+d.tagName+"> has child <"+k+">. Allowed children: "+this.validChildren[d.tagName].toString()+".")}return e},ximpel.Parser.prototype.processConfigNode=function(a){for(var b=this.getDomElementInfo(a),c=new ximpel.ConfigModel,d=0;d<b.nrOfChildElements;d++){var e=b.childElements[d],f=e.nodeName;"enableControls"===f?c.enableControls="false"!==$.trim(e.textContent).toLowerCase():"controlsDisplayMethod"===f?c.controlsDisplayMethod=$.trim(e.textContent):"mediaDirectory"===f?c.mediaDirectory=$.trim(e.textContent):"showScore"===f?c.showScore="true"===$.trim(e.textContent).toLowerCase():ximpel.warn("Parser.processConfigNode(): Invalid child ignored! Element <"+b.tagName+"> has child <"+f+">.This child element is not allowed on <"+b.tagName+">.")}return c},ximpel.Parser.prototype.getChildElementNodes=function(a){if(a.children)return a.children;for(var b=a.childNodes.length,c=[],d=0;d<b;d++){var e=a.childNodes[d];1===e.nodeType&&c.push(e)}return c},ximpel.Parser.prototype.getDomElementInfo=function(a){var b={};return b.tagName=a.nodeName,b.attributes=a.attributes,b.nrOfAttributes=b.attributes.length,b.childElements=this.getChildElementNodes(a),b.nrOfChildElements=b.childElements.length,b},ximpel.MediaPlayer=function(a,b){this.player=a,this.$playerElement=a.getPlayerElement(),this.mediaModel=null,this.mediaItem=null,this.getPlayTime=null,this.overlaysSortedByStartTime=null,this.overlayIndexToStartNext=0,this.playingOverlays=[],this.mediaPlayerUpdateHandler=null,this.mediaHasEnded=!1,this.pubSub=new ximpel.PubSub,this.state=this.STATE_STOPPED,this.playMediaItemWhenMediaPlayerResumes=!1,this.playTimestamp=0,this.pauseTimestamp=0,this.totalPlayTime=0,this.mediaItemOnEndSubscriptionFunction=null,this.questionManager=null,b&&this.use(b,!0)},ximpel.MediaPlayer.prototype.MEDIA_PLAYER_UPDATE_INTERVAL=50,ximpel.MediaPlayer.prototype.EVENT_MEDIA_PLAYER_END="ended",ximpel.MediaPlayer.prototype.STATE_PLAYING="state_mp_playing",ximpel.MediaPlayer.prototype.STATE_PAUSED="state_mp_paused",ximpel.MediaPlayer.prototype.STATE_STOPPED="state_mp_stopped",ximpel.MediaPlayer.prototype.use=function(a,b){b||this.reset(),this.mediaModel=a,this.mediaItem=this.player.mediaItems[a.mediaId],this.mediaItemOnEndSubscriptionFunction=this.mediaItem.addEventHandler("ended",this.handlePlaybackEnd.bind(this)),this.mediaItem.getPlayTime?this.getPlayTime=this.mediaItem.getPlayTime.bind(this.mediaItem):this.getPlayTime=this.getPlayTimeDefault,this.questionManager=new ximpel.QuestionManager(this.player,this.$playerElement,this.getPlayTime,a.questionLists),this.overlaysSortedByStartTime=this.getOverlaysSortedByStartTime(a.overlays)},ximpel.MediaPlayer.prototype.reset=function(a){this.mediaItem&&(this.mediaItem.removeEventHandler("ended",this.mediaItemOnEndSubscriptionFunction),this.mediaItem.stop()),this.questionManager&&(this.questionManager.stop(),this.questionManager=null),this.turnOffMediaPlayerUpdates(),this.destroyPlayingOverlays(),this.playingOverlays=[],this.overlayIndexToStartNext=0,this.resetPlayTime(),this.resetTotalPlayTime(),this.mediaHasEnded=!1,this.state=this.STATE_STOPPED,this.playMediaItemWhenMediaPlayerResumes=!1,this.mediaItemOnEndSubscriptionFunction=null,a&&this.clearEventHandlers()},ximpel.MediaPlayer.prototype.play=function(a){return a&&this.use(a),this.mediaModel?this.isPlaying()?(ximpel.warn("MediaPlayer.play(): play() called while already playing."),this):this.isPaused()?void this.resume():(this.state=this.STATE_PLAYING,this.mediaItem.play(),this.updatePlayTimeTracking(this.STATE_PLAYING),this.turnOnMediaPlayerUpdates(),this):void ximpel.error("MediaPlayer.play(): cannot start playing because no media model has been specified.")};ximpel.MediaPlayer.prototype.pause=function(){return this.isPaused()?(ximpel.warn("MediaPlayer.pause(): pause() called while already paused."),this):(this.state=this.STATE_PAUSED,this.mediaItem.isPlaying()?(this.playMediaItemWhenMediaPlayerResumes=!0,this.mediaItem.pause()):this.playMediaItemWhenMediaPlayerResumes=!1,this.updatePlayTimeTracking(this.STATE_PAUSED),this.turnOffMediaPlayerUpdates(),this)};ximpel.MediaPlayer.prototype.resume=function(){return this.isPaused()?(this.playMediaItemWhenMediaPlayerResumes===!0&&this.mediaItem.play(),this.state=this.STATE_PLAYING,this.updatePlayTimeTracking(this.STATE_PLAYING),this.turnOnMediaPlayerUpdates(),this):(ximpel.warn("MediaPlayer.resume(): resume() called while not paused."),this)},ximpel.MediaPlayer.prototype.stop=function(){return this.isStopped()?this:(this.updatePlayTimeTracking(this.STATE_STOPPED),this.reset(),this)},ximpel.MediaPlayer.prototype.updateMediaPlayer=function(){var a=this.getPlayTime();this.mediaHasEnded||this.updateOverlays(a),this.mediaHasEnded||this.questionManager.update(a),this.checkMediaItemDuration(a)},ximpel.MediaPlayer.prototype.updateOverlays=function(a){for(var b=0;b<this.playingOverlays.length;b++){var c=this.playingOverlays[b].endTime;a>=c&&0!==c&&(this.playingOverlays[b].view.destroy(),this.playingOverlays.splice(b,1),b--)}for(var d=this.overlaysSortedByStartTime.length,b=this.overlayIndexToStartNext;b<d;b++){var e=this.overlaysSortedByStartTime[b];if(e.startTime>a||0===a)break;var f=new ximpel.OverlayView(e);f.render(this.$playerElement),f.onOneClick(this.handleOverlayClick.bind(this,e,f));var c=e.duration>0?e.startTime+e.duration:0;this.playingOverlays.push({view:f,model:e,endTime:c}),this.overlayIndexToStartNext++}},ximpel.MediaPlayer.prototype.handleOverlayClick=function(a,b){if(this.isPaused())return b.onOneClick(this.handleOverlayClick.bind(this,a,b)),void ximpel.warn("MediaPlayer.handleOverlayClick(): Cannot use overlays when in a paused state!");this.player.applyVariableModifiers(a.variableModifiers);var c=this.player.determineLeadsTo(a.leadsToList);if(c){var d="url:";if(0===c.toLowerCase().indexOf(d)){this.isPlaying()&&(this.player.pause(),b.onOneClick(this.handleOverlayClick.bind(this,a,b)));var e=c.substr(d.length);$player=this.player,$urlDisplay=$('<div class="urlDisplay"></div>'),$closeButton=$('<img class="closeButton" src="ximpel/images/close_button.png"/>').one("click",function(){$urlDisplay.remove(),$player.isPaused()&&$player.resume()}),$urlDisplay.append($('<iframe src="'+e+'"></iframe>')).append($closeButton).appendTo(this.player.getPlayerElement())}else this.player.goTo(c)}},ximpel.MediaPlayer.prototype.checkMediaItemDuration=function(a){var b=this.mediaModel.duration||0;a>=b&&0!==b&&this.handleDurationEnd()},ximpel.MediaPlayer.prototype.handleMediaEnd=function(){if(this.mediaHasEnded=!0,this.mediaModel.repeat)return void this.replayMediaItem();this.turnOffMediaPlayerUpdates(),this.mediaItem.pause();var a=this.player.determineLeadsTo(this.mediaModel.leadsToList);a?this.player.goTo(a):this.pubSub.publish(this.EVENT_MEDIA_PLAYER_END)},ximpel.MediaPlayer.prototype.handlePlaybackEnd=function(){this.handleMediaEnd()},ximpel.MediaPlayer.prototype.handleDurationEnd=function(){this.handleMediaEnd()},ximpel.MediaPlayer.prototype.replayMediaItem=function(){this.totalPlayTime+=this.getPlayTime(),this.mediaItem.stop(),this.mediaItem.play()},ximpel.MediaPlayer.prototype.getTotalPlayTime=function(){return this.totalPlayTime+this.getPlayTime()},ximpel.MediaPlayer.prototype.updatePlayTimeTracking=function(a){if(a===this.STATE_PLAYING){var b=0===this.pauseTimestamp?0:Date.now()-this.pauseTimestamp;this.playTimestamp=0===this.playTimestamp?Date.now():this.playTimestamp+b,this.pauseTimestamp=0}else a===this.STATE_PAUSED?this.pauseTimestamp=0===this.pauseTimestamp?Date.now():this.pauseTimestamp:a===this.STATE_STOPPED&&(this.playTimestamp=0,this.pauseTimestamp=0)},ximpel.MediaPlayer.prototype.getPlayTimeDefault=function(){var a=Date.now(),b=0===this.pauseTimestamp?0:a-this.pauseTimestamp,c=a-this.playTimestamp+b;return c},ximpel.MediaPlayer.prototype.turnOnMediaPlayerUpdates=function(){this.mediaPlayerUpdateHandler=setTimeout(function(){this.turnOnMediaPlayerUpdates(),this.updateMediaPlayer()}.bind(this),this.MEDIA_PLAYER_UPDATE_INTERVAL)},ximpel.MediaPlayer.prototype.turnOffMediaPlayerUpdates=function(){this.mediaPlayerUpdateHandler&&clearTimeout(this.mediaPlayerUpdateHandler),this.mediaPlayerUpdateHandler=null},ximpel.MediaPlayer.prototype.destroyPlayingOverlays=function(){this.playingOverlays.forEach(function(a){a.view.destroy()}.bind(this))},ximpel.MediaPlayer.prototype.getOverlaysSortedByStartTime=function(a){var b=a.slice().sort(function(a,b){return a.startTime===b.startTime?a.index-b.index:a.startTime-b.startTime});return b},ximpel.MediaPlayer.prototype.addEventHandler=function(a,b){return this.pubSub.subscribe(a,b),this},ximpel.MediaPlayer.prototype.clearEventHandlers=function(a){return this.pubSub.reset(),this},ximpel.MediaPlayer.prototype.isPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.MediaPlayer.prototype.isPaused=function(){return this.state===this.STATE_PAUSED},ximpel.MediaPlayer.prototype.isStopped=function(){return this.state===this.STATE_STOPPED},ximpel.MediaPlayer.prototype.resetPlayTime=function(){this.pauseTimestamp=0,this.playTimestamp=0},ximpel.MediaPlayer.prototype.resetTotalPlayTime=function(){this.totalPlayTime=0},ximpel.QuestionManager=function(a,b,c,d){this.player=a,this.$el=b,this.getPlayTime=c,this.queuedQuestionLists=[],this.currentQuestionListModel=null,this.currentQuestion=null,this.questionListsSortedByStartTime=null,this.questionListIndexToQueueNext=0,this.questionIndexToStartNext=0,d&&this.use(d,!0)},ximpel.QuestionManager.prototype.use=function(a,b){b||this.reset(),this.questionListsSortedByStartTime=this.getQuestionListsSortedByStartTime(a)},ximpel.QuestionManager.prototype.reset=function(){this.currentQuestion&&this.currentQuestion.view.destroy(),this.queuedQuestionLists=[],this.currentQuestionListModel=null,this.questionListsSortedByStartTime=null,this.questionListIndexToQueueNext=0,this.currentQuestion=null,this.questionIndexToStartNext=0},ximpel.QuestionManager.prototype.update=function(a){if(this.checkForQuestionListsToQueue(a),this.currentQuestion&&this.currentQuestionListModel&&a>=this.currentQuestion.endAt&&0!==this.currentQuestion.endAt){var b=this.currentQuestion.view;b.isAnswered!==!0&&b.hideQuestion()}this.queuedQuestionLists.length>0&&!this.currentQuestionListModel&&a>0&&this.playNextQuestionListInQueue(a)},ximpel.QuestionManager.prototype.stop=function(){this.reset()},ximpel.QuestionManager.prototype.checkForQuestionListsToQueue=function(a){for(var b=this.questionListIndexToQueueNext;b<this.questionListsSortedByStartTime.length;b++){var c=this.questionListsSortedByStartTime[b];if(c.startTime>a)return;this.queuedQuestionLists.push(c),this.questionListIndexToQueueNext++}},ximpel.QuestionManager.prototype.playNextQuestionListInQueue=function(a){var b=this.queuedQuestionLists.shift();b&&(this.currentQuestionListModel=b,this.playQuestion(this.questionIndexToStartNext,a))},ximpel.QuestionManager.prototype.playQuestion=function(a,b){var c=this.currentQuestionListModel.questions[a],d=new ximpel.QuestionView(c),e=this.currentQuestionListModel.questionTimeLimit,f=c.questionTimeLimit,g=f||0===f?f:e,h=0===g?0:b+g;this.currentQuestion={index:a,model:c,view:d,endAt:h},this.questionIndexToStartNext=a+1,d.addEventHandler(d.EVENT_QUESTION_ENDED,this.handleQuestionAnswer.bind(this,c)),d.addEventHandler(d.EVENT_QUESTION_ENDED,this.nextQuestion.bind(this)),d.render(this.$el)},ximpel.QuestionManager.prototype.handleQuestionAnswer=function(a,b){a.answer===b&&this.player.applyVariableModifiers(a.variableModifiers)},ximpel.QuestionManager.prototype.nextQuestion=function(){this.currentQuestion.view.destroy(),this.currentQuestion=null,this.hasNextQuestion()?this.playQuestion(this.questionIndexToStartNext,this.getPlayTime()):this.stopQuestionList()},ximpel.QuestionManager.prototype.hasNextQuestion=function(){return!!this.currentQuestionListModel.questions[this.questionIndexToStartNext]},ximpel.QuestionManager.prototype.stopQuestionList=function(){this.questionIndexToStartNext=0,this.currentQuestionListModel=null},ximpel.QuestionManager.prototype.getQuestionListsSortedByStartTime=function(a){var b=a.slice().sort(function(a,b){return a.startTime-b.startTime});return b},ximpel.SequencePlayer=function(a,b){this.player=a,this.mediaPlayer=new ximpel.MediaPlayer(a),this.mediaPlayer.addEventHandler(this.mediaPlayer.EVENT_MEDIA_PLAYER_END,this.handleMediaPlayerEnd.bind(this)),this.sequenceModel=null,this.currentSequenceIndex=0,this.currentModel=null,this.pubSub=new ximpel.PubSub,this.state=this.STATE_STOPPED,b&&this.use(b,!0)},ximpel.SequencePlayer.prototype.EVENT_SEQUENCE_END="EVENT_SEQUENCE_END",ximpel.SequencePlayer.prototype.STATE_PLAYING="state_sp_playing",ximpel.SequencePlayer.prototype.STATE_PAUSED="state_sp_paused",ximpel.SequencePlayer.prototype.STATE_STOPPED="state_sp_stopped",ximpel.SequencePlayer.prototype.use=function(a,b){b||this.reset(),this.sequenceModel=a},ximpel.SequencePlayer.prototype.reset=function(a){this.mediaPlayer.stop(),this.state=this.STATE_STOPPED,this.currentModel=null,this.currentSequenceIndex=0,a&&this.clearEventHandlers()},ximpel.SequencePlayer.prototype.play=function(a){return a&&this.use(a),this.sequenceModel?this.isPlaying()?(ximpel.warn("SequencePlayer.play(): play() called while already playing."),this):this.isPaused()?(this.resume(),this):(this.state=this.STATE_PLAYING,this.playbackController(),this):void ximpel.error("SequencePlayer.play(): cannot start playing because no sequence model has been specified.")},ximpel.SequencePlayer.prototype.playbackController=function(){var a=this.getNextItemToPlay();a?a instanceof ximpel.MediaModel?(this.playMediaModel(a),this.currentSequenceIndex++):a instanceof ParallelMediaModel:this.pubSub.publish(this.EVENT_SEQUENCE_END)},ximpel.SequencePlayer.prototype.resume=function(){return this.isPaused()?(this.currentModel instanceof ximpel.MediaModel?this.mediaPlayer.resume():itemToPlay instanceof ParallelMediaModel,this.state=this.STATE_PLAYING,this):(ximpel.warn("SequencePlayer.resume(): resume() called while not in a paused state."),this)},ximpel.SequencePlayer.prototype.playMediaModel=function(a){this.currentModel=a,this.player.applyVariableModifiers(a.variableModifiers),this.mediaPlayer.play(a)},ximpel.SequencePlayer.prototype.pause=function(){return this.isPlaying()?(this.state=this.STATE_PAUSED,this.mediaPlayer.pause(),this):(ximpel.warn("SequencePlayer.pause(): pause() called while not in a playing state."),this)},ximpel.SequencePlayer.prototype.stop=function(){return this.isStopped()?(ximpel.warn("SequencePlayer.stop(): stop() called while already in a stopped state."),this):(this.state=this.STATE_STOPPED,this.reset(),this)},ximpel.SequencePlayer.prototype.isPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.SequencePlayer.prototype.isPaused=function(){return this.state===this.STATE_PAUSED},ximpel.SequencePlayer.prototype.isStopped=function(){return this.state===this.STATE_STOPPED},ximpel.SequencePlayer.prototype.handleMediaPlayerEnd=function(){this.playbackController()},ximpel.SequencePlayer.prototype.getNextItemToPlay=function(){return this.currentSequenceIndex<this.sequenceModel.list.length?this.sequenceModel.list[this.currentSequenceIndex]:null},ximpel.SequencePlayer.prototype.addEventHandler=function(a,b){return this.pubSub.subscribe(a,b),this},ximpel.SequencePlayer.prototype.clearEventHandlers=function(a){return this.pubSub.reset(),this},ximpel.MediaType=function(){},ximpel.MediaType.prototype.EVENT_MEDIA_END="ended",ximpel.MediaType.prototype.play=function(){return this.mediaPlay?this.mediaPlay():ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaPlay() method."),this},ximpel.MediaType.prototype.pause=function(){return this.mediaPause?this.mediaPause():ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaPause() method."),this},ximpel.MediaType.prototype.stop=function(){return this.mediaStop?this.mediaStop():ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaStop() method."),this},ximpel.MediaType.prototype.isPlaying=function(){return this.mediaIsPlaying?this.mediaIsPlaying():void ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaIsPlaying() method.")},ximpel.MediaType.prototype.isPaused=function(){return this.mediaIsPaused?this.mediaIsPaused():void ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaIsPaused() method.")},ximpel.MediaType.prototype.isStopped=function(){return this.mediaIsStopped?this.mediaIsStopped():void ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaIsStopped() method.")},ximpel.MediaType.prototype.ended=function(){return this.mediaEnded&&this.mediaEnded(),this.lazyLoadPubSub().publish(this.EVENT_MEDIA_END),this},ximpel.MediaType.prototype.destroy=function(){return this.mediaDestroy?this.mediaDestroy():(this.__mediaTypePubSub__=null,this)},ximpel.MediaType.prototype.onEnd=function(a){return this.addEventHandler(this.EVENT_MEDIA_END,a)},ximpel.MediaType.prototype.addEventHandler=function(a,b){switch(a){case this.EVENT_MEDIA_END:return this.lazyLoadPubSub().subscribe(this.EVENT_MEDIA_END,b);default:return ximpel.warn("MediaType.addEventHandler(): event type '"+a+"' is not supported."),null}},ximpel.MediaType.prototype.removeEventHandler=function(a,b){switch(a){case this.EVENT_MEDIA_END:return this.lazyLoadPubSub().unsubscribe(this.EVENT_MEDIA_END,b),!0;default:return ximpel.warn("MediaType.removeEventHandler(): event type '"+a+"' is not supported."),!1}},ximpel.MediaType.prototype.lazyLoadPubSub=function(){return this.__mediaTypePubSub__||(this.__mediaTypePubSub__=new ximpel.PubSub),this.__mediaTypePubSub__},ximpel.MediaTypeRegistration=function(a,b,c){var c=c||{};this.mediaTypeId=a,this.mediaTypeConstructor=b,this.allowedAttributes=c.allowedAttributes||[],this.requiredAttributes=c.reguiredAttributes||[],this.allowedChildren=c.allowedChildren||[],this.requiredChildren=c.requiredChildren||[]},ximpel.PubSub=function(){this.topics={}},ximpel.PubSub.prototype.reset=function(){this.topics={}},ximpel.PubSub.prototype.subscribe=function(a,b){return this.topics[a]||(this.topics[a]=[]),this.topics[a].push(b),b},ximpel.PubSub.prototype.unsubscribe=function(a,b){if(!this.topics[a])return this;for(var c=this.topics[a],d=0;d<c.length;d++){var e=c[d];e==b&&(c.splice(d,1),c.length<=0&&delete this.topics[a])}return this},ximpel.PubSub.prototype.publish=function(a,b){if(!this.topics[a]||this.topics[a].length<=0)return this;for(var c=this.topics[a],d=0;d<c.length;d++){var e=c[d];e(b)}return this},ximpel.PubSub.prototype.deleteTopic=function(a){return delete this.topics[a],this},ximpel.PubSub.prototype.hasSubscribers=function(a){if(this.topics[a]&&this.topics[a].length>0)return!0},ximpel.XimpelAppView=function(a,b,c,d){this.$appElement=this.determineAppElement(b),this.init(a,this.$appElement),this.initialAppWidth=this.determineAppWidth(c),this.initialAppHeight=this.determineAppHeight(d),this.$playerElement=$("<div></div>"),this.$controlsElement=$("<div></div>"),this.$wrapperElement=$("<div></div>"),this.$playButtonElement=$("<div></div>"),this.$pauseButtonElement=$("<div></div>"),this.$stopButtonElement=$("<div></div>"),this.$fullscreenButtonElement=$("<div></div>"),this.pubSub=new ximpel.PubSub,this.initElements()},ximpel.XimpelAppView.prototype=new ximpel.View,ximpel.XimpelAppView.prototype.DEFAULT_XIMPEL_APP_ELEMENT_ID="XIMPEL",ximpel.XimpelAppView.prototype.Z_INDEX_BASE_MAIN_ELEMENTS=16e6,ximpel.XimpelAppView.prototype.Z_INDEX_CONTROLS=ximpel.XimpelAppView.prototype.Z_INDEX_BASE_MAIN_ELEMENTS+2e3,ximpel.XimpelAppView.prototype.Z_INDEX_PLAYER=ximpel.XimpelAppView.prototype.Z_INDEX_BASE_MAIN_ELEMENTS+1e3,ximpel.XimpelAppView.prototype.NATIVE_PLAYER_ELEMENT_WIDTH="1920px",ximpel.XimpelAppView.prototype.NATIVE_PLAYER_ELEMENT_HEIGHT="1080px",ximpel.XimpelAppView.prototype.DEFAULT_APP_WIDTH="1024px",ximpel.XimpelAppView.prototype.DEFAULT_APP_HEIGHT="576px",ximpel.XimpelAppView.prototype.DEFAULT_CONTROL_HEIGHT="125px",ximpel.XimpelAppView.prototype.DEFAULT_CONTROL_WIDTH="125px",ximpel.XimpelAppView.prototype.APP_ELEMENT_CLASS="ximpelApp",ximpel.XimpelAppView.prototype.WRAPPER_ELEMENT_CLASS="ximpelWrapper",ximpel.XimpelAppView.prototype.PLAYER_ELEMENT_CLASS="ximpelPlayer",ximpel.XimpelAppView.prototype.CONTROLS_CLASS="ximpelControls",ximpel.XimpelAppView.prototype.CONTROL_CLASS="ximpelControl",ximpel.XimpelAppView.prototype.CONTROLS_DISPLAY_METHOD_OVERLAY_CLASS="ximpelControlsOverlay",ximpel.XimpelAppView.prototype.CONTROLS_DISPLAY_METHOD_FIXED_CLASS="ximpelControlsFixed",ximpel.XimpelAppView.prototype.CONTROLS_DISPLAY_METHOD_OVERLAY="overlay",ximpel.XimpelAppView.prototype.CONTROLS_DISPLAY_METHOD_FIXED="fixed",ximpel.XimpelAppView.prototype.PLAY_EVENT="play_button_clicked",ximpel.XimpelAppView.prototype.PAUSE_EVENT="pause_button_clicked",ximpel.XimpelAppView.prototype.STOP_EVENT="stop_button_clicked",ximpel.XimpelAppView.prototype.initElements=function(){this.initAppElement(),this.initPlayerElement(),this.initControlsElement(),this.initWrapperElement(),this.initButtonElements()},ximpel.XimpelAppView.prototype.initAppElement=function(){this.$appElement.css({position:"relative",width:this.initialAppWidth,height:this.initialAppHeight}),this.$appElement.addClass(this.APP_ELEMENT_CLASS)},ximpel.XimpelAppView.prototype.initPlayerElement=function(){this.$playerElement.css({position:"absolute",top:"0px",left:"0px",width:this.NATIVE_PLAYER_ELEMENT_WIDTH,height:this.NATIVE_PLAYER_ELEMENT_HEIGHT,"z-index":this.Z_INDEX_PLAYER}),this.$playerElement.addClass(this.PLAYER_ELEMENT_CLASS),this.$playerElement.appendTo(this.$wrapperElement)},ximpel.XimpelAppView.prototype.initControlsElement=function(){this.$controlsElement.hide(),this.$controlsElement.css({position:"absolute",top:this.$playerElement.height()+"px",left:"0px",width:"100%",height:this.DEFAULT_CONTROL_HEIGHT,"z-index":this.Z_INDEX_CONTROLS}),this.updateControlsElementClass(),this.$controlsElement.appendTo(this.$wrapperElement)},ximpel.XimpelAppView.prototype.initWrapperElement=function(){this.$wrapperElement.css({position:"absolute",top:"0px",left:"0px",width:this.$playerElement.width()+"px",height:this.$playerElement.height()+"px"}),this.$wrapperElement.addClass(this.WRAPPER_ELEMENT_CLASS),this.$wrapperElement.appendTo(this.$appElement)},ximpel.XimpelAppView.prototype.initButtonElements=function(){var a=this.DEFAULT_CONTROL_HEIGHT,b=this.DEFAULT_CONTROL_WIDTH;this.initButtonElement(this.$playButtonElement,"ximpel/images/play_button.png","left",a,b,this.playHandler.bind(this)),this.initButtonElement(this.$pauseButtonElement,"ximpel/images/pause_button.png","left",a,b,this.pauseHandler.bind(this)),this.initButtonElement(this.$stopButtonElement,"ximpel/images/stop_button.png","left",a,b,this.stopHandler.bind(this)),this.initButtonElement(this.$fullscreenButtonElement,"ximpel/images/fullscreen_button.png","right",a,b,this.fullscreenHandler.bind(this))},ximpel.XimpelAppView.prototype.initButtonElement=function(a,b,c,d,e,f){a.css({float:c,"background-image":"url("+b+")","background-size":"cover",height:e,width:d}),a.hover(function(){$(this).css("cursor","pointer")},function(){$(this).css("cursor","default")}),a.addClass(this.CONTROL_CLASS),a.on("click",f),a.hide(),a.appendTo(this.$controlsElement)},ximpel.XimpelAppView.prototype.renderView=function(a){var a=(this.model,a||this.$appElement.parent());(!a||a.length<=0)&&(a=$(document.body)),this.$appElement.parent().length<=0&&this.$appElement.appendTo(a),this.renderControls(),this.renderWrapper(),this.listenForWindowResize(),this.listenForKeyPresses(),this.listenForFullscreenChange()},ximpel.XimpelAppView.prototype.renderControls=function(){if(this.controlsEnabled()){this.updateControlsElementClass();var a=this.determineControlsPosition();this.$controlsElement.css({left:a.x+"px",top:a.y+"px"}),this.$controlsElement.show(),this.renderControlButtons()}},ximpel.XimpelAppView.prototype.renderControlButtons=function(){var a=this.$controlsElement.height(),b=a;this.model.appReadyState===this.model.APP_READY_STATE_READY&&this.renderPlaybackButtons(b,a),this.$fullscreenButtonElement.show()},ximpel.XimpelAppView.prototype.renderPlaybackButtons=function(a,b){this.model.playerState===this.model.PLAYER_STATE_PLAYING?(this.$playButtonElement.hide(),this.$pauseButtonElement.show(),this.$stopButtonElement.show()):this.model.playerState===this.model.PLAYER_STATE_PAUSED?(this.$pauseButtonElement.hide(),this.$playButtonElement.show(),this.$stopButtonElement.show()):this.model.PLAYER_STATE_STOPPED&&(this.$pauseButtonElement.hide(),this.$stopButtonElement.hide(),this.$playButtonElement.show())},ximpel.XimpelAppView.prototype.fullscreenHandler=function(){this.toggleFullscreen()},ximpel.XimpelAppView.prototype.playHandler=function(){this.pubSub.publish(this.PLAY_EVENT)},ximpel.XimpelAppView.prototype.pauseHandler=function(){this.pubSub.publish(this.PAUSE_EVENT)},ximpel.XimpelAppView.prototype.stopHandler=function(){this.pubSub.publish(this.STOP_EVENT)},ximpel.XimpelAppView.prototype.registerPlayHandler=function(a){return this.pubSub.subscribe(this.PLAY_EVENT,a)},ximpel.XimpelAppView.prototype.registerPauseHandler=function(a){return this.pubSub.subscribe(this.PAUSE_EVENT,a)},ximpel.XimpelAppView.prototype.registerStopHandler=function(a){return this.pubSub.subscribe(this.STOP_EVENT,a)},ximpel.XimpelAppView.prototype.updateControlsElementClass=function(){switch(this.$controlsElement.removeClass(),this.getControlsDisplayMethod()){case this.CONTROLS_DISPLAY_METHOD_OVERLAY:var a=this.CONTROLS_DISPLAY_METHOD_OVERLAY_CLASS;break;case this.CONTROLS_DISPLAY_METHOD_FIXED:var a=this.CONTROLS_DISPLAY_METHOD_FIXED_CLASS}this.$controlsElement.addClass(this.CONTROLS_CLASS+" "+a)},ximpel.XimpelAppView.prototype.renderWrapper=function(){var a=this.determineWrapperDimensions();this.$wrapperElement.css({width:a.width+"px",height:a.height+"px"}),this.$wrapperElement.show();var b=this.$appElement.width(),c=this.$appElement.height(),d=this.$wrapperElement.width(),e=this.$wrapperElement.height();this.scaleToFit(this.$wrapperElement,b,c,d,e);var f=this.$wrapperElement[0].getBoundingClientRect().width,g=this.$wrapperElement[0].getBoundingClientRect().height;this.repositionInCenter(this.$wrapperElement,b,c,f,g)},ximpel.XimpelAppView.prototype.determineControlsPosition=function(){var a=this.determineWrapperDimensions(),b=this.getControlsDisplayMethod();if(b===this.CONTROLS_DISPLAY_METHOD_OVERLAY)var c=0,d=a.height-this.$controlsElement.height();else if(b===this.CONTROLS_DISPLAY_METHOD_FIXED)var c=0,d=a.height-this.$controlsElement.height();else var c=0,d=0;return{x:c,y:d}},ximpel.XimpelAppView.prototype.determineWrapperDimensions=function(){var a=this.getControlsDisplayMethod(),b=this.controlsEnabled();if(b){if(a===this.CONTROLS_DISPLAY_METHOD_OVERLAY)var c=this.$playerElement.width(),d=this.$playerElement.height();else if(a===this.CONTROLS_DISPLAY_METHOD_FIXED)var c=this.$playerElement.width(),d=this.$playerElement.height()+this.$controlsElement.height()}else var c=this.$playerElement.width(),d=this.$playerElement.height();return{width:c,height:d}},ximpel.XimpelAppView.prototype.destroyView=function(){},ximpel.XimpelAppView.prototype.listenForWindowResize=function(){var a,b="ximpelAppViewWindowResize_"+this.model.appId;$(window).off("resize."+b),$(window).on("resize."+b,function(){clearTimeout(a),a=setTimeout(this.windowResizeHandler.bind(this),100)}.bind(this))},ximpel.XimpelAppView.prototype.windowResizeHandler=function(){this.render()},ximpel.XimpelAppView.prototype.listenForKeyPresses=function(){var a="ximpelAppView_"+this.model.appId;this.$appElement.off("keypress."+a),this.$appElement.on("keypress."+a,function(a){102===a.which?this.toggleFullscreen():115===a.which?this.playHandler():113===a.which?this.stopHandler():112===a.which&&this.pauseHandler()}.bind(this))},ximpel.XimpelAppView.prototype.toggleFullscreen=function(){var a=this.$appElement[0];return this.fullscreenElement()?void this.exitFullscreen():void(this.fullscreenSupported()&&this.requestFullscreen(a))},ximpel.XimpelAppView.prototype.exitFullscreen=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else{if(!document.msExitFullscreen)return!1;document.msExitFullscreen()}return!0},ximpel.XimpelAppView.prototype.fullscreenElement=function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement},ximpel.XimpelAppView.prototype.requestFullscreen=function(a){if(a.requestFullscreen)a.requestFullscreen();else if(a.webkitRequestFullscreen)a.webkitRequestFullscreen();else if(a.mozRequestFullScreen)a.mozRequestFullScreen();else{if(!a.msRequestFullscreen)return!1;a.msRequestFullscreen()}return!0},ximpel.XimpelAppView.prototype.fullscreenSupported=function(){return document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled},ximpel.XimpelAppView.prototype.listenForFullscreenChange=function(){var a="ximpelAppViewFullscreen_"+this.model.appId;$(document).off("webkitfullscreenchange."+a+" mozfullscreenchange."+a+" fullscreenchange."+a+" MSFullscreenChange."+a),$(document).on("webkitfullscreenchange."+a+" mozfullscreenchange."+a+" fullscreenchange."+a+" MSFullscreenChange."+a,this.fullscreenChangeHandler.bind(this));
},ximpel.XimpelAppView.prototype.fullscreenChangeHandler=function(){var a=this.fullscreenElement();a?(this.$appElement.width($(window).width()),this.$appElement.height($(window).height())):(this.$appElement.width(this.initialAppWidth),this.$appElement.height(this.initialAppHeight)),this.render()},ximpel.XimpelAppView.prototype.getScaleFactor=function(a,b,c,d){var e=Math.min(a/c,b/d);return e},ximpel.XimpelAppView.prototype.getCenteredRectangleCoordinates=function(a,b,c,d){var e=Math.abs(Math.round((a-c)/2)),f=Math.abs(Math.round((b-d)/2));return{x:e,y:f}},ximpel.XimpelAppView.prototype.getPlayerElement=function(){return this.$playerElement},ximpel.XimpelAppView.prototype.scaleToFit=function(a,b,c,d,e){var f=this.getScaleFactor(b,c,d,e);a.css({"-webkit-transform":"scale("+f+","+f+")","-moz-transform":"scale("+f+","+f+")","-ms-transform":"scale("+f+","+f+")","-o-transform":"scale("+f+","+f+")",transform:"scale("+f+","+f+")","-webkit-transform-origin":"top left","-moz-transform-origin":"top left","-ms-transform-origin":"top left","-o-transform-origin":"top left","transform-origin":"top left"})},ximpel.XimpelAppView.prototype.repositionInCenter=function(a,b,c,d,e){var f=this.getCenteredRectangleCoordinates(b,c,d,e);a.css({left:f.x+"px",top:f.y+"px"})},ximpel.XimpelAppView.prototype.getControlsDisplayMethod=function(){return this.model.configModel.controlsDisplayMethod},ximpel.XimpelAppView.prototype.controlsEnabled=function(){return this.model.configModel.enableControls},ximpel.XimpelAppView.prototype.determineAppWidth=function(a){this.$appElement.parent();return a?a:this.$appElement.width()>0?this.$appElement.width()+"px":this.DEFAULT_APP_WIDTH},ximpel.XimpelAppView.prototype.determineAppHeight=function(a){this.$appElement.parent();return a?a:this.$appElement.height()>0?this.$appElement.height()+"px":this.DEFAULT_APP_HEIGHT},ximpel.XimpelAppView.prototype.determineAppElement=function(a){var b=ximpel.getElement(a);return b||(b=this.createAppElement(a)),b},ximpel.XimpelAppView.prototype.createAppElement=function(a){for(var a=a||this.DEFAULT_XIMPEL_APP_ELEMENT_ID,b=a,c=2;document.getElementById(b);)b=a+"-"+c,c++;var d=$("<div></div>").attr({id:b});return d},ximpel.OverlayView=function(a,b){this.init(a,b)},ximpel.OverlayView.prototype=new ximpel.View,ximpel.OverlayView.prototype.SHAPE_RECTANGLE="rectangle",ximpel.OverlayView.prototype.SHAPE_SQUARE="square",ximpel.OverlayView.prototype.SHAPE_OVAL="oval",ximpel.OverlayView.prototype.SHAPE_CIRCLE="circle",ximpel.OverlayView.prototype.CSS_OVERYLAY_CLASS="overlay",ximpel.OverlayView.prototype.CSS_OVERLAY_OVAL_CLASS="overlayOval",ximpel.OverlayView.prototype.CSS_NO_SELECT_CLASS="noSelect",ximpel.OverlayView.prototype.renderView=function(){var a=this.model,b=$("<div></div>").addClass(this.CSS_NO_SELECT_CLASS).addClass(this.CSS_OVERYLAY_CLASS).css({top:a.y,left:a.x}),c=$("<span></span>");a.text&&c.text(a.text);var d=$("<div></div>");switch(b.append(d),b.append(c),a.shape){case this.SHAPE_RECTANGLE:this.makeRectangle(b,a.width,a.height);break;case this.SHAPE_SQUARE:this.makeSquare(b,a.side);break;case this.SHAPE_OVAL:this.makeOval(b,a.width,a.height);break;case this.SHAPE_CIRCLE:this.makeCircle(b,a.diameter)}this.setInitialOverlayStyle(b,a),b.mouseover(function(){this.setHoverOverlayStyle(b,a)}.bind(this)),b.mouseout(function(){this.setNonHoverOverlayStyle(b,a)}.bind(this)),this.$el.remove(),this.$el=b},ximpel.OverlayView.prototype.setInitialOverlayStyle=function(a,b){a.children("span").css({"text-align":b.textAlign}),b.backgroundImage&&a.children("div").css({"background-image":"url("+b.backgroundImage+")","background-size":"cover","background-repeat":"no-repeat","background-position":"center center"}),this.setNonHoverOverlayStyle(a,b)},ximpel.OverlayView.prototype.setNonHoverOverlayStyle=function(a,b){a.children("span").css({color:b.textColor,"font-size":b.fontSize,"font-family":b.fontFamily}),a.children("div").css({opacity:b.opacity,"background-color":b.backgroundColor})},ximpel.OverlayView.prototype.setHoverOverlayStyle=function(a,b){a.children("span").css({color:b.hoverTextColor||b.textColor,"font-size":b.hoverFontSize||b.fontSize,"font-family":b.hoverFontFamily||b.fontFamily}),a.children("div").css({opacity:b.hoverOpacity,"background-color":b.hoverBackgroundColor||b.backgroundColor})},ximpel.OverlayView.prototype.destroyView=function(){},ximpel.OverlayView.prototype.makeRectangle=function(a,b,c){return b=this.ensureUnit(b,"px"),c=this.ensureUnit(c,"px"),a.css({width:b,height:c,"line-height":c}),this},ximpel.OverlayView.prototype.makeSquare=function(a,b){this.makeRectangle(a,b,b)},ximpel.OverlayView.prototype.makeOval=function(a,b,c){return b=this.ensureUnit(b,"px"),c=this.ensureUnit(c,"px"),a.addClass(this.CSS_OVERLAY_OVAL_CLASS),a.css({width:b,height:c,"line-height":c,"border-radius":"50%"}),this},ximpel.OverlayView.prototype.makeCircle=function(a,b){return this.makeOval(a,b,b),this},ximpel.OverlayView.prototype.ensureUnit=function(a,b){var b=b||"px";return this.isNumeric(a.toString().slice(-1))?a+b:a},ximpel.OverlayView.prototype.isNumeric=function(a){return(a>0||0===a||"0"===a||a<0)&&a!==!0&&isFinite(a)},ximpel.QuestionView=function(a,b){this.init(a,b),this.questionFontSize="40px",this.nextQuestionIndex=0,this.$optionsContainer=null,this.isAnswered=!1,this.timeoutHandlerQuestionAnsweredPause=null},ximpel.QuestionView.prototype=new ximpel.View,ximpel.QuestionView.prototype.EVENT_QUESTION_ANSWERED="answered",ximpel.QuestionView.prototype.EVENT_QUESTION_ENDED="ended",ximpel.QuestionView.prototype.CSS_QUESTION_CLASS="question",ximpel.QuestionView.prototype.CSS_QUESTION_TEXT_CLASS="questionText",ximpel.QuestionView.prototype.CSS_QUESTION_OPTION_CLASS="questionOption",ximpel.QuestionView.prototype.CSS_NO_SELECT_CLASS="noSelect",ximpel.QuestionView.prototype.renderView=function(){for(var a=this.model,b=this.$question=$("<div></div>").addClass(this.CSS_QUESTION_CLASS).addClass(this.CSS_NO_SELECT_CLASS).css({"text-align":"center",width:"100%","min-height":"100px",top:"15%",left:"0px","font-size":this.questionFontSize,padding:"0px 0px 0px 0px"}),c=$("<div></div>").addClass(this.CSS_QUESTION_TEXT_CLASS).css({"background-color":"rgba( 0, 0, 0, 0.8 )",color:"white",float:"left",width:"70%",padding:"10px 0px 10px 0px",margin:"0px 15% 0px 15%"}).html(a.questionText),d=$("<div></div>").css({float:"left",width:"70%",padding:"0px 15% 0px 15%"}),e=0;e<a.options.length;e++){var f=a.options[e],g=$("<span></span>").css({"background-color":"rgba( 255, 255, 255, 0.7 )",color:"black",display:"block",cursor:"pointer",width:"100%",padding:"10px 0px 10px 0px"}).mouseover(function(){$(this).css("background-color","rgba( 255, 255, 255, 0.9 )")}).mouseout(function(){$(this).css("background-color","rgba( 255, 255, 255, 0.7 )")}).addClass(this.CSS_QUESTION_OPTION_CLASS);g.one("click",function(a,b,c){this.questionAnswerHandler(a,b,c)}.bind(this,d,g,f.optionName));var h=f.optionText,i=$(document.createTextNode(h));g.append(i),d.append(g)}b.append(c),b.append(d),this.$optionsContainer=d,this.$el.remove(),this.$el=b},ximpel.QuestionView.prototype.questionAnswerHandler=function(a,b,c){this.isAnswered=!0;var d=a.find("."+this.CSS_QUESTION_OPTION_CLASS);d.off("mouseover mouseout click"),this.model.answer===c?b.css("background-color","rgba(0, 255, 0, 0.7)"):b.css("background-color","rgba(255, 0, 0, 0.7)"),this.timeoutHandlerQuestionAnsweredPause=setTimeout(function(){this.$el.fadeOut(400,function(){this.pubSub.publish(this.EVENT_QUESTION_ENDED,c)}.bind(this))}.bind(this),1e3),this.pubSub.publish(this.EVENT_QUESTION_ANSWERED,c)},ximpel.QuestionView.prototype.hideQuestion=function(){var a=this.$optionsContainer.find("."+this.CSS_QUESTION_OPTION_CLASS);a.off("mouseover mouseout click"),this.$el.fadeOut(400,function(){this.pubSub.publish(this.EVENT_QUESTION_ENDED)}.bind(this))},ximpel.QuestionView.prototype.addEventHandler=function(a,b){switch(a){case this.EVENT_QUESTION_ENDED:return this.pubSub.subscribe(this.EVENT_QUESTION_ENDED,b);case this.EVENT_QUESTION_ANSWERED:return this.pubSub.subscribe(this.EVENT_QUESTION_ANSWERED,b);default:return ximpel.warn("QuestionView.addEventHandler(): event type '"+a+"' is not supported."),null}},ximpel.QuestionView.prototype.removeEventHandler=function(a,b){switch(a){case"end":return this.pubSub.unsubscribe(this.EVENT_QUESTION_ENDED,b),!0;default:return ximpel.warn("QuestionView.removeEventHandler(): event type '"+a+"' is not supported. Can't add/remove event handlers of this type."),!1}},ximpel.QuestionView.prototype.destroyView=function(){this.$el.stop(!0),clearTimeout(this.timeoutHandlerQuestionAnsweredPause)},ximpel.mediaTypeDefinitions.Video=function(a,b,c,d){this.customElements=a,this.customAttributes=b,this.$attachTo=c,this.player=d,this.mute="true"===this.customAttributes.mute||!1,this.x=this.customAttributes.x||"center",this.y=this.customAttributes.y||"center",this.width=this.customAttributes.width,this.height=this.customAttributes.height,this.startTime=b.startTime||0,this.$video=null;var e=ximpel.filterArrayOfObjects(a,"elementName","source")[0];this.$htmlSourceElements=this.getHtmlSourceElements(e),this.bufferingPromise=null,this.state=this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Video.prototype=new ximpel.MediaType,ximpel.mediaTypeDefinitions.Video.prototype.STATE_PLAYING="state_video_playing",ximpel.mediaTypeDefinitions.Video.prototype.STATE_PAUSED="state_video_paused",ximpel.mediaTypeDefinitions.Video.prototype.STATE_STOPPED="state_video_stopped",ximpel.mediaTypeDefinitions.Video.prototype.mediaPlay=function(){if(this.state!==this.STATE_PLAYING){if(this.state===this.STATE_PAUSED)return void this.resumePlayback();this.state=this.STATE_PLAYING;var a=this.$video=$("<video />",{preload:"none"}),b=a[0];a.append(this.$htmlSourceElements),a.on("ended",this.ended.bind(this)),a.one("loadedmetadata",function(){b.currentTime=this.startTime,this.$video.appendTo(this.$attachTo),this.calculateVideoDetails()}.bind(this));var c=new $.Deferred;return c.done(function(){this.state===this.STATE_PLAYING&&(a.prop("muted",this.mute),b.play())}.bind(this)),a.one("canplaythrough",function(){c.resolve()}.bind(this)),a.error(function(a){ximpel.warn("Video.mediaPlay(): failed to buffer the video: '"+b.src+"'."),c.reject()}.bind(this)),b.load(),this.bufferingPromise=c.promise(),this.bufferingPromise}},ximpel.mediaTypeDefinitions.Video.prototype.resumePlayback=function(){this.state=this.STATE_PLAYING,"resolved"===this.bufferingPromise.state()&&this.$video[0].play()},ximpel.mediaTypeDefinitions.Video.prototype.mediaPause=function(){this.state===this.STATE_PLAYING&&(this.state=this.STATE_PAUSED,this.$video[0].pause())},ximpel.mediaTypeDefinitions.Video.prototype.mediaStop=function(){if(this.state!==this.STATE_STOPPED){this.state=this.STATE_STOPPED;var a=this.$video,b=this.$video[0];b.pause(),b.src="",b.load(),a.detach(),a.remove(),this.$video=null,this.bufferingPromise=null}},ximpel.mediaTypeDefinitions.Video.prototype.mediaIsPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.mediaTypeDefinitions.Video.prototype.mediaIsPaused=function(){return this.state===this.STATE_PAUSED},ximpel.mediaTypeDefinitions.Video.prototype.mediaIsStopped=function(){return this.state===this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Video.prototype.calculateVideoDetails=function(){var a=this.$attachTo.width(),b=this.$attachTo.height(),c="center"===this.x?"0px":this.x,d="center"===this.y?"0px":this.y;if(this.width||this.height)if(this.width)if(this.height)var i=this.width,j=this.height;else var i=this.width,j="auto";else var i="auto",j=this.height;else{var e=this.$video[0].videoWidth,f=this.$video[0].videoHeight,g=e/f,h=a/b;if(g>=h)var i="100%",j="auto";else var i="auto",j="100%"}if(this.$video.css({position:"absolute",width:i,height:j,left:c,top:d}),"center"===this.x)var c=Math.round(Math.abs(this.$attachTo.width()-this.$video.width())/2);if("center"===this.y)var d=Math.round(Math.abs(this.$attachTo.height()-this.$video.height())/2);this.$video.css({left:c,top:d})},ximpel.mediaTypeDefinitions.Video.prototype.getPlayTime=function(){var a=this.$video[0];return a.currentTime&&0!=a.currentTime?1e3*(a.currentTime-this.startTime):0},ximpel.mediaTypeDefinitions.Video.prototype.getHtmlSourceElements=function(a){var b=a.elementAttributes.file,c=a.elementAttributes.extensions||"";c=c.replace(/\s/g,""),extensionsArray=c.split(",");var d=a.elementAttributes.types||"";d=d.replace(/\s/g,""),typesArray=""!==d?d.split(","):[];for(var e=$([]),f=0;f<extensionsArray.length;f++){var g=typesArray[f]||"",h=b+"."+extensionsArray[f],i=this.player.getConfigProperty("mediaDirectory")||"";""!=i&&(h=i+"/"+h);var j=$("<source />").attr({src:h,type:g});e=e.add(j)}return e};var mediaTypeRegistrationObject=new ximpel.MediaTypeRegistration("video",ximpel.mediaTypeDefinitions.Video,{allowedAttributes:["mute","width","height","x","y","startTime"],requiredAttributes:[],allowedChildren:["source"],requiredChildren:["source"]});ximpel.registerMediaType(mediaTypeRegistrationObject),ximpel.mediaTypeDefinitions.Image=function(a,b,c,d){this.customElements=a,this.customAttributes=b,this.$attachTo=c,this.player=d,this.x=this.customAttributes.x||"center",this.y=this.customAttributes.y||"center",this.width=this.customAttributes.width,this.height=this.customAttributes.height;var e=d.getConfigProperty("mediaDirectory")||"";this.imageSource=b.src||"",""!=e&&(this.imageSource=e+"/"+this.imageSource),this.$image=null,this.loadPromise=null,this.state=this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Image.prototype=new ximpel.MediaType,ximpel.mediaTypeDefinitions.Image.prototype.STATE_PLAYING="state_image_playing",ximpel.mediaTypeDefinitions.Image.prototype.STATE_PAUSED="state_image_paused",ximpel.mediaTypeDefinitions.Image.prototype.STATE_STOPPED="state_image_stopped",ximpel.mediaTypeDefinitions.Image.prototype.mediaPlay=function(){if(this.state!==this.STATE_PLAYING){if(this.state===this.STATE_PAUSED)return void this.resumePlayback();this.state=this.STATE_PLAYING,this.$image=$("<img />");var a=new $.Deferred;return this.$image.on("load",function(){a.resolve(),this.$image.appendTo(this.$attachTo),this.calculateImageDetails()}.bind(this)),this.$image.on("error",function(){ximpel.warn("Image.mediaPreload(): failed to preload image '"+$image[0].src+"'."),a.reject()}),this.$image.attr("src",this.imageSource),this.loadPromise=a.promise(),this.loadPromise}},ximpel.mediaTypeDefinitions.Image.prototype.resumePlayback=function(){this.state=this.STATE_PLAYING},ximpel.mediaTypeDefinitions.Image.prototype.mediaPause=function(){this.state===this.STATE_PLAYING&&(this.state=this.STATE_PAUSED)},ximpel.mediaTypeDefinitions.Image.prototype.mediaStop=function(){this.state!==this.STATE_STOPPED&&(this.state=this.STATE_STOPPED,this.$image.detach(),this.$image.remove(),this.$image=null,this.loadPromise=null)},ximpel.mediaTypeDefinitions.Image.prototype.mediaIsPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.mediaTypeDefinitions.Image.prototype.mediaIsPaused=function(){return this.state===this.STATE_PAUSED},ximpel.mediaTypeDefinitions.Image.prototype.mediaIsStopped=function(){return this.state===this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Image.prototype.calculateImageDetails=function(){var a=this.$attachTo.width(),b=this.$attachTo.height(),c="center"===this.x?"0px":this.x,d="center"===this.y?"0px":this.y;if(this.width||this.height)if(this.width)if(this.height)var i=this.width,j=this.height;else var i=this.width,j="auto";else var i="auto",j=this.height;else{var e=this.$image[0].width,f=this.$image[0].height,g=e/f,h=a/b;if(g>=h)var i="100%",j="auto";else var i="auto",j="100%"}if(this.$image.attr({width:i,height:j}).css({position:"absolute",left:c,top:d}),"center"===this.x)var c=Math.round(Math.abs(this.$attachTo.width()-this.$image.width())/2);if("center"===this.y)var d=Math.round(Math.abs(this.$attachTo.height()-this.$image.height())/2);this.$image.css({left:c,top:d})};var mediaTypeRegistrationObject=new ximpel.MediaTypeRegistration("image",ximpel.mediaTypeDefinitions.Image,{allowedAttributes:["src","width","height","x","y"],requiredAttributes:["src"],allowedChildren:[],requiredChildren:[]});ximpel.registerMediaType(mediaTypeRegistrationObject),ximpel.mediaTypeDefinitions.Audio=function(a,b,c,d){this.customElements=a,this.customAttributes=b,this.$attachTo=c,this.player=d,this.startTime=b.startTime||0,this.$audio=null;var e=ximpel.filterArrayOfObjects(a,"elementName","source")[0];this.$htmlSourceElements=this.getHtmlSourceElements(e),this.bufferingPromise=null,this.state=this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Audio.prototype=new ximpel.MediaType,ximpel.mediaTypeDefinitions.Audio.prototype.STATE_PLAYING="state_audio_playing",ximpel.mediaTypeDefinitions.Audio.prototype.STATE_PAUSED="state_audio_paused",ximpel.mediaTypeDefinitions.Audio.prototype.STATE_STOPPED="state_audio_stopped",ximpel.mediaTypeDefinitions.Audio.prototype.mediaPlay=function(){if(this.state!==this.STATE_PLAYING){if(this.state===this.STATE_PAUSED)return void this.resumePlayback();this.state=this.STATE_PLAYING;var a=this.$audio=$("<audio />",{preload:"none"}),b=a[0];a.append(this.$htmlSourceElements),a.on("ended",this.ended.bind(this)),a.one("loadedmetadata",function(){b.currentTime=this.startTime,a.appendTo(this.$attachTo)}.bind(this));var c=new $.Deferred;return c.done(function(){this.state===this.STATE_PLAYING&&b.play()}.bind(this)),a.one("canplaythrough",function(){c.resolve()}.bind(this)),a.error(function(a){ximpel.warn("Audio.mediaPlay(): failed to buffer the audio: '"+b.src+"'."),c.reject()}.bind(this)),b.load(),this.bufferingPromise=c.promise(),this.bufferingPromise}},ximpel.mediaTypeDefinitions.Audio.prototype.resumePlayback=function(){this.state=this.STATE_PLAYING,"resolved"===this.bufferingPromise.state()&&this.$audio[0].play()},ximpel.mediaTypeDefinitions.Audio.prototype.mediaPause=function(){this.state===this.STATE_PLAYING&&(this.state=this.STATE_PAUSED,this.$audio[0].pause())},ximpel.mediaTypeDefinitions.Audio.prototype.mediaStop=function(){if(this.state!==this.STATE_STOPPED){this.state=this.STATE_STOPPED;var a=this.$audio,b=this.$audio[0];b.pause(),b.src="",b.load(),a.detach(),a.remove(),this.$audio=null,this.bufferingPromise=null}},ximpel.mediaTypeDefinitions.Audio.prototype.mediaIsPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.mediaTypeDefinitions.Audio.prototype.mediaIsPaused=function(){return this.state===this.STATE_PAUSED},ximpel.mediaTypeDefinitions.Audio.prototype.mediaIsStopped=function(){return this.state===this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Audio.prototype.getPlayTime=function(){var a=this.$audio[0];return 0==a.currentTime?0:1e3*(a.currentTime-this.startTime)},ximpel.mediaTypeDefinitions.Audio.prototype.getHtmlSourceElements=function(a){var b=a.elementAttributes.file,c=a.elementAttributes.extensions||"";c=c.replace(/\s/g,""),extensionsArray=c.split(",");var d=a.elementAttributes.types||"";d=d.replace(/\s/g,""),typesArray=""!==d?d.split(","):[];for(var e=$([]),f=0;f<extensionsArray.length;f++){var g=typesArray[f]||"",h=b+"."+extensionsArray[f],i=this.player.getConfigProperty("mediaDirectory")||"";""!=i&&(h=i+"/"+h);var j=$("<source />").attr({src:h,type:g});e=e.add(j)}return e};var mediaTypeRegistrationObject=new ximpel.MediaTypeRegistration("audio",ximpel.mediaTypeDefinitions.Audio,{allowedAttributes:[],requiredAttributes:[],allowedChildren:["source"],requiredChildren:["source"]});ximpel.registerMediaType(mediaTypeRegistrationObject),ximpel.mediaTypeDefinitions.YouTube=function(a,b,c,d){this.customElements=a,this.customAttributes=b,this.$attachTo=c,this.player=d,this.videoId=b.id,this.mute=b.mute,this.x=b.x||"center",this.y=b.y||"center",this.width=b.width||this.$attachTo.width()+"px",this.height=b.height||this.$attachTo.height()+"px",this.startTime=b.startTime||0,this.$youtubeContainer=null,this.$youtubePlaceholder=null,this.$youtubeClickCatcher=null,this.youtubePlayer=null,this.readyToPlayPromise=null,this.state=this.STATE_STOPPED},ximpel.mediaTypeDefinitions.YouTube.prototype=new ximpel.MediaType,ximpel.mediaTypeDefinitions.YouTube.prototype.CLASS_YOUTUBE_CONTAINER="youtubeContainer",ximpel.mediaTypeDefinitions.YouTube.prototype.CLASS_YOUTUBE_CLICK_CATCHER="youtubeClickCatcher",ximpel.mediaTypeDefinitions.YouTube.prototype.STATE_PLAYING="state_youtube_playing",ximpel.mediaTypeDefinitions.YouTube.prototype.STATE_PAUSED="state_youtube_paused",ximpel.mediaTypeDefinitions.YouTube.prototype.STATE_STOPPED="state_youtube_stopped",ximpel.mediaTypeDefinitions.YouTube.prototype.mediaPlay=function(){if(this.state!==this.STATE_PLAYING){if(this.state===this.STATE_PAUSED)return void this.resumePlayback();if(this.state=this.STATE_PLAYING,!ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise)var a=this.loadYoutubeApi();this.initYoutubeElements();var b=new $.Deferred,c=$.when(a,b);if(this.readyToPlayPromise=c.promise(),c.done(function(){this.playYoutube()}.bind(this)),"resolved"===ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise.state())this.loadYoutubePlayer(b);else if("pending"===ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise.state())ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise.done(function(){this.loadYoutubePlayer(b)}.bind(this));else if("rejected"===ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise.state())return void ximpel.warn("YouTube.mediaPlay(): failed to play the youtube element the youtube API didn't load properly.")}},ximpel.mediaTypeDefinitions.YouTube.prototype.resumePlayback=function(){this.state=this.STATE_PLAYING,this.readyToPlayPromise&&"resolved"===this.readyToPlayPromise.state()&&this.youtubePlayer.playVideo()},ximpel.mediaTypeDefinitions.YouTube.prototype.loadYoutubeApi=function(){if(!ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise){var a=new $.Deferred;ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise=a.promise();var b=window.onYouTubeIframeAPIReady;return window.onYouTubeIframeAPIReady=function(){a.resolve(),b&&b()}.bind(this),this.requestYoutubeApiScript(a),a}},ximpel.mediaTypeDefinitions.YouTube.prototype.requestYoutubeApiScript=function(a){var b=$.ajax({type:"GET",url:"https://www.youtube.com/iframe_api",dataType:"script",cache:!0});return b.fail(function(b,c,d){ximpel.warn("YouTube.loadYoutubeApi(): failed to load the youtube api script ("+c+", "+d+")"),a.reject()}.bind(this)),a.promise()},ximpel.mediaTypeDefinitions.YouTube.prototype.loadYoutubePlayer=function(a){var b=function(){a.resolve()};return this.youtubePlayer=new YT.Player(this.$youtubePlaceholder[0],{videoId:this.videoId,height:this.height,width:this.width,events:{onError:this.youtubePlayerErrorHandler.bind(this,a),onReady:b.bind(this),onStateChange:this.youtubePlayerStateChangeHandler.bind(this)},playerVars:{html5:1,autoplay:0,controls:0,rel:0,showinfo:0,disablekb:1,wmode:"opaque",modestbranding:0,iv_load_policy:3,start:this.startTime}}),a},ximpel.mediaTypeDefinitions.YouTube.prototype.playYoutube=function(){this.repositionYoutubeIframe(),this.mute?this.youtubePlayer.mute():this.youtubePlayer.unMute(),this.youtubePlayer.playVideo(),this.$youtubeContainer.show()},ximpel.mediaTypeDefinitions.YouTube.prototype.initYoutubeElements=function(){this.$youtubeContainer=$("<div></div>"),this.$youtubePlaceholder=$("<div></div>"),this.$youtubeClickCatcher=$("<div></div>"),this.$youtubeContainer.addClass(this.CLASS_YOUTUBE_CONTAINER),this.$youtubeClickCatcher.addClass(this.CLASS_YOUTUBE_CLICK_CATCHER);var a=this.$youtubeContainer.add(this.$youtubeClickCatcher);a.css({position:"absolute",width:"100%",height:"100%",top:"0px",left:"0px","z-index":1}),this.$youtubeContainer.hide(),this.$youtubeClickCatcher.appendTo(this.$youtubeContainer),this.$youtubeContainer.appendTo(this.$attachTo),this.$youtubePlaceholder.appendTo(this.$youtubeContainer)},ximpel.mediaTypeDefinitions.YouTube.prototype.repositionYoutubeIframe=function(){var a=this.$youtubeContainer.find("iframe");if(a.css({position:"absolute"}),"center"===this.x)var b=Math.round(Math.abs(this.$attachTo.width()-a.width())/2)+"px";else var b=this.x;if("center"===this.y)var c=Math.round(Math.abs(this.$attachTo.height()-a.height())/2)+"px";else var c=this.y;a.css({left:b,top:c})},ximpel.mediaTypeDefinitions.YouTube.prototype.youtubePlayerErrorHandler=function(a,b){2==b.data?ximpel.warn("YouTube.youtubePlayerErrorHandler(): invalid parameters received. Possibly the video id is invalid."):5==b.data?ximpel.warn("YouTube.youtubePlayerErrorHandler(): The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred."):100==b.data?ximpel.warn("YouTube.youtubePlayerErrorHandler(): The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private."):101==b.data||150==b.data?ximpel.warn("YouTube.youtubePlayerErrorHandler(): The owner of the requested video does not allow it to be played in embedded players."):ximpel.warn("YouTube.youtubePlayerErrorHandler(): An unknown error has occured while starting the youtube player."),a.reject()},ximpel.mediaTypeDefinitions.YouTube.prototype.youtubePlayerStateChangeHandler=function(a){var b=a.data;switch(b){case YT.PlayerState.ENDED:this.ended()}},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaPause=function(){this.state===this.STATE_PLAYING&&(this.state=this.STATE_PAUSED,this.youtubePlayer&&this.youtubePlayer.pauseVideo&&this.youtubePlayer.pauseVideo())},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaStop=function(){this.state!==this.STATE_STOPPED&&(this.state=this.STATE_STOPPED,this.youtubePlayer.pauseVideo(),this.youtubePlayer.destroy(),this.$youtubeContainer.remove(),this.$youtubeContainer=null,this.$youtubePlaceholder=null,this.$youtubeClickCatcher=null,this.youtubePlayer=null,this.readyToPlayPromise=null)},ximpel.mediaTypeDefinitions.YouTube.prototype.getPlayTime=function(){if(!this.youtubePlayer||!this.youtubePlayer.getCurrentTime)return 0;var a=1e3*this.youtubePlayer.getCurrentTime(),b=1e3*this.startTime,c=a-b;return c},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaIsPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaIsPaused=function(){return this.state===this.STATE_PAUSED},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaIsStopped=function(){return this.state===this.STATE_STOPPED};var mediaTypeRegistrationObject=new ximpel.MediaTypeRegistration("youtube",ximpel.mediaTypeDefinitions.YouTube,{allowedAttributes:["mute","videoId","width","height","x","y","startTime"],requiredAttributes:["videoId"],allowedChildren:["source"],requiredChildren:["source"]});ximpel.registerMediaType(mediaTypeRegistrationObject);